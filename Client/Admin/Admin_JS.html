<script>
  // Create a namespace for our app logic to avoid polluting global scope
  window.adminApp = {};

  // --- Global App State (within our namespace) ---
  adminApp.state = {
    isLoading: false,
    currentProjectId: null, 
    projectData: null,      // For loaded project data in later steps
    currentSlideIndex: -1,  // For slide management in later steps
    viewMode: 'list',       // Default, will be overridden by initialize
    initialProjectId: null  // Default, will be overridden by initialize
  };

  // --- DOM Elements (Declare all anticipated elements) ---
  // These will be assigned in adminApp.setupDOMAndListeners
  let projectTitleInputEl, createProjectButtonEl, messageAreaEl, loadingSpinnerEl;
  let listViewContainerEl, /* createProjectSectionEl, projectListSectionEl, */ adminProjectListContainerEl; // create/projectList sections are within listViewContainer
  let editViewContainerEl, editingProjectTitleEl, backToProjectsListButtonEl;

  /**
   * Main initialization function called AFTER server data is fetched by AdminView.html's script block.
   * This function sets up the rest of the application.
   */
  adminApp.initialize = function(modeFromServer, projectIdFromServer) {
    console.log("Admin_JS: adminApp.initialize called with mode:", modeFromServer, "projectId:", projectIdFromServer);
    
    adminApp.state.viewMode = modeFromServer || 'list'; 
    adminApp.state.initialProjectId = projectIdFromServer || null;

    // Now that we have initial state, set up DOM references and listeners
    adminApp.setupDOMReferences();
    adminApp.attachEventListeners();
    
    // Initial View Setup based on fetched server data
    if (adminApp.state.viewMode === 'edit' && adminApp.state.initialProjectId) {
      // adminApp.state.currentProjectId is set inside switchToEditView
      switchToEditView(adminApp.state.initialProjectId);
      // In Step 10, we will call: loadProjectForEditing(adminApp.state.initialProjectId);
    } else {
      switchToListView(); 
      loadAdminProjectsList(); 
    }
    console.log("Admin_JS: Initialization complete. Current view mode:", adminApp.state.viewMode);
  };

  /**
   * Gets references to all necessary DOM elements.
   */
  adminApp.setupDOMReferences = function() {
    messageAreaEl = document.getElementById('messageArea');
    loadingSpinnerEl = document.getElementById('loadingSpinner');
    
    listViewContainerEl = document.getElementById('listViewContainer');
    projectTitleInputEl = document.getElementById('projectTitleInput');
    createProjectButtonEl = document.getElementById('createProjectButton');
    // createProjectSectionEl = document.getElementById('createProjectSection'); // Already part of listViewContainer
    // projectListSectionEl = document.getElementById('projectListSection');     // Already part of listViewContainer
    adminProjectListContainerEl = document.getElementById('adminProjectListContainer');
    
    editViewContainerEl = document.getElementById('editViewContainer');
    editingProjectTitleEl = document.getElementById('editingProjectTitle');
    backToProjectsListButtonEl = document.getElementById('backToProjectsListButton');
    console.log("Admin_JS: DOM references set up.");
  };

  /**
   * Attaches all primary event listeners.
   */
  adminApp.attachEventListeners = function() {
    if (createProjectButtonEl) {
        createProjectButtonEl.addEventListener('click', handleCreateProject);
    } else { console.error("createProjectButtonEl was not found during attachEventListeners!"); }

    if (backToProjectsListButtonEl) {
        backToProjectsListButtonEl.addEventListener('click', navigateToProjectList);
    } else { console.error("backToProjectsListButtonEl was not found during attachEventListeners!"); }
    console.log("Admin_JS: Event listeners attached.");
  };
  
  // --- UI Navigation / View Management ---
  function switchToListView() {
    console.log("Switching to List View");
    adminApp.state.currentProjectId = null; 
    if(listViewContainerEl) listViewContainerEl.style.display = 'block';
    if(editViewContainerEl) editViewContainerEl.style.display = 'none';
    if (messageAreaEl) messageAreaEl.innerHTML = ''; 
  }

  function switchToEditView(projectIdToEdit) {
    console.log("Switching to Edit View for project:", projectIdToEdit);
    adminApp.state.currentProjectId = projectIdToEdit; 
    if(listViewContainerEl) listViewContainerEl.style.display = 'none';
    if(editViewContainerEl) editViewContainerEl.style.display = 'block';
    if(editingProjectTitleEl) editingProjectTitleEl.textContent = `Editing Project (ID: ${projectIdToEdit})`; 
    
    adminApp.state.projectData = null; 
    adminApp.state.currentSlideIndex = -1;
    // if (adminApp.state.fabricCanvasInstance) { adminApp.state.fabricCanvasInstance.clear(); } // For later
    if (messageAreaEl) messageAreaEl.innerHTML = ''; 
  }

  // --- Navigation Functions ---
  function navigateToEditView(projectId) {
    if (adminApp.state.isLoading) return;
    console.log(`Requesting to navigate to edit project: ${projectId}`);
    showLoading(true);
    
    google.script.run
        .withSuccessHandler(function(webAppUrl) {
            // Ensure spinner is hidden before navigation which might take time
            // showLoading(false); // Or let the page reload handle it
            window.location.href = webAppUrl + '?page=edit&projectId=' + projectId;
        })
        .withFailureHandler(function(err) {
            console.error("Could not get webapp URL from server for edit nav, using relative path. Error:", err);
            showLoading(false);
            window.location.href = '?page=edit&projectId=' + projectId;
        })
        .getWebAppUrl();
  }
  
  function navigateToProjectList() {
    if (adminApp.state.isLoading) return;
    console.log("Requesting to navigate back to project list");
    showLoading(true);

    google.script.run
        .withSuccessHandler(function(webAppUrl) {
            // showLoading(false);
            window.location.href = webAppUrl;
        })
        .withFailureHandler(function(err) {
            console.error("Could not get webapp URL from server for list nav, using relative path. Error:", err);
            showLoading(false);
            window.location.href = window.location.origin + window.location.pathname; 
        })
        .getWebAppUrl();
  }

  // --- General UI Functions ---
  function showLoading(show) {
    adminApp.state.isLoading = show;
    if (loadingSpinnerEl) {
      loadingSpinnerEl.style.display = show ? 'flex' : 'none';
    } else if (adminApp.state.isLoading) { // If called before DOM fully ready
        console.warn("showLoading called but loadingSpinnerEl not yet available.");
    }
  }

  function displayMessage(message, isSuccess) {
    if (messageAreaEl) {
      messageAreaEl.innerHTML = ''; 
      const p = document.createElement('p');
      p.textContent = message;
      messageAreaEl.appendChild(p);
      messageAreaEl.className = isSuccess ? 'success' : 'error';
      setTimeout(() => {
        if (messageAreaEl) {
          messageAreaEl.innerHTML = '';
          messageAreaEl.className = '';
        }
      }, 7000); 
    } else {
      console.warn("displayMessage called but messageAreaEl not yet available. Message:", message);
    }
  }
  
  function onServerError(errorObject) {
    showLoading(false); // Ensure spinner is always hidden on error
    console.error('Server Error Object:', errorObject);
    let errorMessage = "An unknown error occurred on the server.";
    if (typeof errorObject === 'string') { 
        errorMessage = errorObject;
    } else if (errorObject && errorObject.message && typeof errorObject.message === 'string') { 
        errorMessage = errorObject.message;
        if (errorObject.details && errorObject.details.length > 0 && errorObject.details[0].errorMessage) {
             errorMessage = errorObject.details[0].errorMessage;
        } else if (errorObject.details && typeof errorObject.details === 'string') {
            errorMessage += " Details: " + errorObject.details;
        }
    } else if (errorObject && errorObject.name && errorObject.message) { 
        errorMessage = `Error: ${errorObject.name} - ${errorObject.message}`;
    }
    displayMessage('Server Error: ' + errorMessage, false);
  }

  // --- Project Creation ---
  function handleCreateProject() {
    console.log("handleCreateProject function called!");
    if (!google || !google.script || !google.script.run) {
      console.error("google.script.run is not available!");
      displayMessage("Error: Client-server communication bridge is not available.", false);
      return;
    }
    if (adminApp.state.isLoading) {
        console.log("handleCreateProject: isLoading is true, returning.");
        return;
    }
    if (!projectTitleInputEl) {
        console.error("projectTitleInputEl is not defined or found in handleCreateProject.");
        displayMessage("Error: Project title input field not found.", false);
        return;
    }
    const currentProjectTitle = projectTitleInputEl.value.trim();
    console.log("handleCreateProject: projectTitle from input =", currentProjectTitle); 
    if (!currentProjectTitle) {
      displayMessage('Project title cannot be empty.', false);
      projectTitleInputEl.focus();
      return;
    }
    showLoading(true);
    google.script.run
      .withSuccessHandler(onProjectCreated)
      .withFailureHandler(onServerError)
      .createProject(currentProjectTitle);
  }

  function onProjectCreated(response) {
    showLoading(false);
    console.log("onProjectCreated response:", response);
    if (response && response.success) {
      displayMessage(response.message || 'Project created successfully!', true);
      if(projectTitleInputEl) projectTitleInputEl.value = ''; 
      console.log("Project created data:", response);
      loadAdminProjectsList(); // Refresh the list
    } else {
      let serverError = (response && response.error) ? response.error : { message: 'Failed to create project. No specific error from server.' };
      onServerError(serverError);
    }
  }

  // --- Project List ---
  function loadAdminProjectsList() {
    console.log("loadAdminProjectsList called");
    if (!google || !google.script || !google.script.run) {
      console.error("google.script.run is not available for loadAdminProjectsList!");
      displayMessage("Error: Client-server communication bridge is not available.", false);
      showLoading(false); // Ensure loading is hidden if we can't proceed
      return;
    }
    if (!adminProjectListContainerEl) { // Check if container is ready
        console.error("adminProjectListContainerEl not ready for loadAdminProjectsList. Deferring or error.");
        // Optionally, you could retry or wait if this happens due to timing.
        // For now, just log and potentially show an error.
        showLoading(false);
        return;
    }
    showLoading(true);
    google.script.run
      .withSuccessHandler(displayAdminProjects)
      .withFailureHandler(onServerError)
      .getAllProjectsForAdmin();
  }

  function displayAdminProjects(projectsArray) {
    showLoading(false);
    console.log("displayAdminProjects received:", projectsArray);
    if (!adminProjectListContainerEl) {
        console.error("adminProjectListContainerEl is not found. Cannot display projects.");
        return;
    }
    adminProjectListContainerEl.innerHTML = ''; 
    if (!projectsArray || projectsArray.length === 0) {
      adminProjectListContainerEl.innerHTML = '<p>No projects found.</p>';
      return;
    }
    projectsArray.forEach(project => {
      if (!project || !project.projectId) { 
          console.warn("Skipping invalid project object during display:", project);
          return; 
      }
      const projectItem = document.createElement('div');
      projectItem.className = 'project-item';
      
      const titleSpan = document.createElement('span');
      titleSpan.textContent = project.projectTitle || 'Untitled Project';
      
      const statusSpan = document.createElement('span');
      statusSpan.className = 'status';
      statusSpan.textContent = `(${project.status || 'N/A'})`;

      const titleAndStatusDiv = document.createElement('div');
      titleAndStatusDiv.appendChild(titleSpan);
      titleAndStatusDiv.appendChild(statusSpan);

      const editButton = document.createElement('button');
      editButton.textContent = 'Edit';
      editButton.className = 'edit-button'; 
      editButton.setAttribute('data-project-id', project.projectId); 
      editButton.onclick = function() { 
        navigateToEditView(project.projectId); 
      };

      projectItem.appendChild(titleAndStatusDiv);
      projectItem.appendChild(editButton);
      adminProjectListContainerEl.appendChild(projectItem);
    });
  }

  // Note: The actual execution starts when adminApp.initialize is called from AdminView.html
  // after google.script.run.getServerData() completes.
</script>