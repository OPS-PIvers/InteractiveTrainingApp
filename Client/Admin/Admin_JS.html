<script>
  window.adminApp = {}; // Namespace

  // --- App State ---
  adminApp.state = {
    isLoading: false,
    currentProjectId: null, // ID of project being "edited"
    currentView: 'list'     // Can be 'list' or 'edit'
    // projectData: null,    // For later steps
    // currentSlideIndex: -1 // For later steps
  };

  // --- DOM Elements ---
  let projectTitleInputEl, createProjectButtonEl, messageAreaEl, loadingSpinnerEl;
  let listViewContainerEl, adminProjectListContainerEl;
  let editViewContainerEl, editingProjectTitleEl, backToProjectsListButtonEl;

  // --- Initialization ---
  document.addEventListener('DOMContentLoaded', function() {
    console.log("Admin_JS: DOMContentLoaded event fired!");
    
    adminApp.setupDOMReferences();
    adminApp.attachEventListeners();
    
    switchToListView(); // Default view on load
    loadAdminProjectsList();
    
    console.log("Admin_JS: Initialization complete. Default view: list");
  });

  adminApp.setupDOMReferences = function() {
    messageAreaEl = document.getElementById('messageArea');
    loadingSpinnerEl = document.getElementById('loadingSpinner');
    listViewContainerEl = document.getElementById('listViewContainer');
    projectTitleInputEl = document.getElementById('projectTitleInput');
    createProjectButtonEl = document.getElementById('createProjectButton');
    adminProjectListContainerEl = document.getElementById('adminProjectListContainer');
    editViewContainerEl = document.getElementById('editViewContainer');
    editingProjectTitleEl = document.getElementById('editingProjectTitle');
    backToProjectsListButtonEl = document.getElementById('backToProjectsListButton');
    console.log("Admin_JS: DOM references set up.");
  };

  adminApp.attachEventListeners = function() {
    if (createProjectButtonEl) {
        createProjectButtonEl.addEventListener('click', handleCreateProject);
    } else { console.error("createProjectButtonEl was not found!"); }

    if (backToProjectsListButtonEl) {
        backToProjectsListButtonEl.addEventListener('click', switchToListView); // Simply switch view
    } else { console.error("backToProjectsListButtonEl was not found!"); }
    console.log("Admin_JS: Event listeners attached.");
  };
  
  // --- UI View Management ---
  function switchToListView() {
    console.log("Switching to List View");
    adminApp.state.currentView = 'list';
    adminApp.state.currentProjectId = null; 
    
    if(listViewContainerEl) listViewContainerEl.style.display = 'block';
    if(editViewContainerEl) editViewContainerEl.style.display = 'none';
    if (messageAreaEl) messageAreaEl.innerHTML = ''; 
    // Consider reloading project list if returning from an edit that might have changed status etc.
    // loadAdminProjectsList(); // Optional: uncomment if you want to refresh list every time.
  }

  function switchToEditView(projectIdToEdit) {
    console.log("Switching to Edit View for project:", projectIdToEdit);
    adminApp.state.currentView = 'edit';
    adminApp.state.currentProjectId = projectIdToEdit; 
    
    if(listViewContainerEl) listViewContainerEl.style.display = 'none';
    if(editViewContainerEl) editViewContainerEl.style.display = 'block';
    if(editingProjectTitleEl) editingProjectTitleEl.textContent = `Editing Project (ID: ${projectIdToEdit})`; 
    
    // adminApp.state.projectData = null; // Reset for when actual data loading happens
    // adminApp.state.currentSlideIndex = -1;
    if (messageAreaEl) messageAreaEl.innerHTML = ''; 
    // In Step 10, you will call: loadProjectForEditing(projectIdToEdit);
  }

  // --- General UI Functions (showLoading, displayMessage, onServerError) ---
  function showLoading(show) {
    adminApp.state.isLoading = show;
    if (loadingSpinnerEl) {
      loadingSpinnerEl.style.display = show ? 'flex' : 'none';
    } else if (show) { 
        console.warn("showLoading(true) called but loadingSpinnerEl not yet available.");
    }
  }
  // displayMessage and onServerError as previously defined...
  function displayMessage(message, isSuccess) { /* ... same ... */ }
  function onServerError(errorObject) { /* ... same ... */ }


  // --- Project Creation ---
  function handleCreateProject() {
    console.log("handleCreateProject called");
    if (adminApp.state.isLoading) return;
    // ... (rest of create project logic: get title, validate, call server)
    const currentProjectTitle = projectTitleInputEl.value.trim();
    if (!currentProjectTitle) { /* ... handle empty ... */ return; }
    showLoading(true);
    google.script.run
      .withSuccessHandler(onProjectCreated)
      .withFailureHandler(onServerError)
      .createProject(currentProjectTitle);
  }

  function onProjectCreated(response) {
    showLoading(false);
    if (response && response.success) {
      displayMessage(response.message || 'Project created successfully!', true);
      if(projectTitleInputEl) projectTitleInputEl.value = ''; 
      loadAdminProjectsList(); // Refresh the list
    } else { /* ... handle error ... */ }
  }

  // --- Project List ---
  function loadAdminProjectsList() {
    console.log("loadAdminProjectsList called");
    if (!adminProjectListContainerEl) {
        console.log("loadAdminProjectsList: adminProjectListContainerEl not ready yet. Waiting for DOM setup.");
        return; // DOM not ready
    }
    showLoading(true);
    google.script.run
      .withSuccessHandler(displayAdminProjects)
      .withFailureHandler(onServerError)
      .getAllProjectsForAdmin();
  }

  function displayAdminProjects(projectsArray) {
    showLoading(false);
    console.log("displayAdminProjects received:", projectsArray ? projectsArray.length : 0, "projects");
    if (!adminProjectListContainerEl) { /* ... error ... */ return; }
    adminProjectListContainerEl.innerHTML = ''; 
    if (!projectsArray || projectsArray.length === 0) {
      adminProjectListContainerEl.innerHTML = '<p>No projects found.</p>';
      return;
    }
    projectsArray.forEach(project => {
      if (!project || !project.projectId) { /* ... skip invalid ... */ return; }
      const projectItem = document.createElement('div');
      projectItem.className = 'project-item';
      // ... create title, status spans ...
      const titleSpan = document.createElement('span'); titleSpan.textContent = project.projectTitle || 'Untitled';
      const statusSpan = document.createElement('span'); statusSpan.className = 'status'; statusSpan.textContent = `(${project.status || 'N/A'})`;
      const titleAndStatusDiv = document.createElement('div'); titleAndStatusDiv.appendChild(titleSpan); titleAndStatusDiv.appendChild(statusSpan);

      const editButton = document.createElement('button');
      editButton.textContent = 'Edit';
      editButton.className = 'edit-button'; 
      editButton.setAttribute('data-project-id', project.projectId); 
      // CHANGED: onclick now calls switchToEditView directly
      editButton.onclick = function() { 
        console.log("Edit button clicked for project ID:", project.projectId);
        switchToEditView(project.projectId); 
      };

      projectItem.appendChild(titleAndStatusDiv);
      projectItem.appendChild(editButton);
      adminProjectListContainerEl.appendChild(projectItem);
    });
  }
</script>