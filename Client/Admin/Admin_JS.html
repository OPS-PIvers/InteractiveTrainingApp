<script>
  // Namespace for the admin application
  window.adminApp = {};

  // --- Application State ---
  adminApp.state = {
    isLoading: false,
    currentProjectId: null, // ID of the project currently being "edited"
    currentView: 'list',    // Tracks the current visible view: 'list' or 'edit'
    projectData: null,      // Will hold the full data for the project being edited (from Step 10)
    currentSlideIndex: -1,  // For slide management (from Step 9) - Will be properly used soon
    fabricCanvasInstance: null // For Fabric.js canvas (from Step 7)
  };

  // --- DOM Element References ---
  // Will be populated by adminApp.setupDOMReferences
  let projectTitleInputEl, createProjectButtonEl, messageAreaEl, loadingSpinnerEl;
  let listViewContainerEl, adminProjectListContainerEl;
  let editViewContainerEl, editingProjectTitleEl, backToProjectsListButtonEl, fabricCanvasEl;
  let imageUploaderEl; // Added for Step 8

  // --- Initialization ---
  document.addEventListener('DOMContentLoaded', function() {
    console.log("Admin_JS: DOMContentLoaded event fired!");
    
    adminApp.setupDOMReferences();
    adminApp.attachEventListeners(); // Listener for imageUploaderEl will be attached here
    
    switchToListView(); 
    loadAdminProjectsList(); 
    
    console.log("Admin_JS: Initialization complete. Default view: 'list'");
  });

  /**
   * Gets references to all necessary DOM elements from the page.
   */
  adminApp.setupDOMReferences = function() {
    messageAreaEl = document.getElementById('messageArea');
    loadingSpinnerEl = document.getElementById('loadingSpinner');
    
    listViewContainerEl = document.getElementById('listViewContainer');
    projectTitleInputEl = document.getElementById('projectTitleInput');
    createProjectButtonEl = document.getElementById('createProjectButton');
    adminProjectListContainerEl = document.getElementById('adminProjectListContainer');
    
    editViewContainerEl = document.getElementById('editViewContainer');
    editingProjectTitleEl = document.getElementById('editingProjectTitle');
    backToProjectsListButtonEl = document.getElementById('backToProjectsListButton');
    fabricCanvasEl = document.getElementById('fabricCanvasElement');
    imageUploaderEl = document.getElementById('imageUploader'); // Should find it here

    if (!listViewContainerEl || !editViewContainerEl) {
        console.error("CRITICAL: Main view containers not found!");
    }
    if (!imageUploaderEl) { // This would be an issue
        console.error("CRITICAL: imageUploaderEl NOT found during setupDOMReferences. Check AdminView.html for ID 'imageUploader'.");
    }
    console.log("Admin_JS: DOM references set up.");
  };

  /**
   * Attaches primary event listeners to DOM elements.
   */
  adminApp.attachEventListeners = function() {
    if (createProjectButtonEl) {
        createProjectButtonEl.addEventListener('click', handleCreateProject);
    } else { console.error("createProjectButtonEl was not found during attachEventListeners!"); }

    if (backToProjectsListButtonEl) {
        backToProjectsListButtonEl.addEventListener('click', switchToListView);
    } else { console.error("backToProjectsListButtonEl was not found during attachEventListeners!"); }

    if (imageUploaderEl) { // Listener attached here
        imageUploaderEl.addEventListener('change', handleImageUpload);
        console.log("Admin_JS: Event listener attached to imageUploaderEl.");
    } else {
        // This error means setupDOMReferences failed to find it, which is the root problem
        console.error("CRITICAL: imageUploaderEl not found during attachEventListeners, cannot attach listener. Check setupDOMReferences and HTML.");
    }
    console.log("Admin_JS: Event listeners attached (general).");
  };
  
  // --- UI View Management ---
  function switchToListView() {
    console.log("Switching to List View");
    adminApp.state.currentView = 'list';
    adminApp.state.currentProjectId = null; 
    
    if(listViewContainerEl) listViewContainerEl.style.display = 'block';
    if(editViewContainerEl) editViewContainerEl.style.display = 'none';
    
    if (messageAreaEl) messageAreaEl.innerHTML = ''; 
  }

  function switchToEditView(projectIdToEdit) {
    console.log("Switching to Edit View for project ID:", projectIdToEdit);
    adminApp.state.currentView = 'edit';
    adminApp.state.currentProjectId = projectIdToEdit; 
    
    if(listViewContainerEl) listViewContainerEl.style.display = 'none';
    if(editViewContainerEl) editViewContainerEl.style.display = 'block'; 
    
    if(editingProjectTitleEl) {
        editingProjectTitleEl.textContent = `Editing Project (ID: ${projectIdToEdit})`; 
    }
    
    // Reset data that might be related to a previously edited project
    adminApp.state.projectData = null; 
    adminApp.state.currentSlideIndex = -1; // Will be important in Step 9
    
    // Dispose previous canvas instance if it exists
    if (adminApp.state.fabricCanvasInstance) { 
      adminApp.state.fabricCanvasInstance.dispose();
      adminApp.state.fabricCanvasInstance = null;
      console.log("Admin_JS: Disposed previous Fabric canvas instance.");
    }
    if (messageAreaEl) messageAreaEl.innerHTML = ''; 

    // Ensure fabricCanvasEl is available (it should have been found in setupDOMReferences)
    if (!fabricCanvasEl) { 
        fabricCanvasEl = document.getElementById('fabricCanvasElement'); 
    }

    // Initialize Fabric.js on the canvas
    if (typeof fabric !== 'undefined' && fabricCanvasEl) {
      // Define default canvas dimensions (e.g., 16:9 aspect ratio)
      const defaultCanvasWidth = 960;
      const defaultCanvasHeight = Math.round(defaultCanvasWidth * (9 / 16)); // 540

      adminApp.state.fabricCanvasInstance = new fabric.Canvas('fabricCanvasElement', {
        width: defaultCanvasWidth, 
        height: defaultCanvasHeight, 
        backgroundColor: '#e9e9e9' // A slightly different default background
      });

      // Update the HTML canvas element's attributes to match these default dimensions for layout
      fabricCanvasEl.width = defaultCanvasWidth;
      fabricCanvasEl.height = defaultCanvasHeight;
      
      // Optional: If you have a container and want to set its initial size too
      // const canvasContainer = document.getElementById('fabricCanvasContainer');
      // if (canvasContainer) {
      //    canvasContainer.style.width = defaultCanvasWidth + 'px';
      //    canvasContainer.style.height = defaultCanvasHeight + 'px';
      // }

      console.log("Admin_JS: Fabric.js canvas initialized with default dimensions: " + defaultCanvasWidth + "x" + defaultCanvasHeight, adminApp.state.fabricCanvasInstance);
    } else if (!fabricCanvasEl) {
      console.error("Admin_JS: fabricCanvasEl not found! Cannot initialize Fabric.js.");
      displayMessage("Error: Canvas element not found. Cannot initialize editor.", false);
    } else {
      // Fabric.js library is not loaded
      console.error("Admin_JS: Fabric.js library (fabric) is not defined yet. Ensure AdminView.html includes the Fabric.js CDN script in the <head>.");
      displayMessage("Error: Canvas library (Fabric.js) could not be loaded. Please check AdminView.html, your internet connection, ensure scripts are not blocked, and try refreshing.", false);
    }

    // In Step 10, you will call: loadProjectForEditing(projectIdToEdit);
    // This function (loadProjectForEditing) will then be responsible for:
    // 1. Fetching project data.
    // 2. If loading a slide with a saved custom canvas size (due to a background image), 
    //    it will resize the canvas (using canvas.setWidth/setHeight and updating fabricCanvasEl.width/height)
    //    to those saved dimensions BEFORE loading the slide's background and objects.
  }

  // --- General UI Functions ---
  function showLoading(show) {
    adminApp.state.isLoading = show;
    if (loadingSpinnerEl) {
      loadingSpinnerEl.style.display = show ? 'flex' : 'none';
    } else if (show) { 
        console.warn("showLoading(true) called but loadingSpinnerEl not yet available.");
    }
  }

  function displayMessage(message, isSuccess) {
    if (messageAreaEl) {
      messageAreaEl.innerHTML = ''; 
      const p = document.createElement('p');
      p.textContent = message;
      messageAreaEl.appendChild(p);
      messageAreaEl.className = isSuccess ? 'success' : 'error';
      setTimeout(() => {
        if (messageAreaEl) {
          messageAreaEl.innerHTML = '';
          messageAreaEl.className = '';
        }
      }, 7000); 
    } else {
      console.warn("displayMessage called but messageAreaEl not available. Message:", message);
    }
  }
  
  function onServerError(errorObject) {
    showLoading(false);
    console.error('Server Error Object:', errorObject);
    let errorMessage = "An unknown error occurred on the server.";
    if (typeof errorObject === 'string') { 
        errorMessage = errorObject;
    } else if (errorObject && errorObject.message && typeof errorObject.message === 'string') { 
        errorMessage = errorObject.message;
        if (errorObject.details && errorObject.details.length > 0 && errorObject.details[0].errorMessage) {
             errorMessage = errorObject.details[0].errorMessage;
        } else if (errorObject.details && typeof errorObject.details === 'string') {
            errorMessage += " Details: " + errorObject.details;
        }
    } else if (errorObject && errorObject.name && errorObject.message) { 
        errorMessage = `Error: ${errorObject.name} - ${errorObject.message}`;
    }
    displayMessage('Server Error: ' + errorMessage, false);
  }

  // --- Project Creation (Step 3) ---
  function handleCreateProject() {
    if (adminApp.state.isLoading) return;
    const currentProjectTitle = projectTitleInputEl.value.trim();
    if (!currentProjectTitle) {
      displayMessage('Project title cannot be empty.', false);
      projectTitleInputEl.focus();
      return;
    }
    showLoading(true);
    google.script.run
      .withSuccessHandler(onProjectCreated)
      .withFailureHandler(onServerError)
      .createProject(currentProjectTitle);
  }

  function onProjectCreated(response) {
    showLoading(false);
    if (response && response.success) {
      displayMessage(response.message || 'Project created successfully!', true);
      if(projectTitleInputEl) projectTitleInputEl.value = ''; 
      loadAdminProjectsList(); 
    } else {
      onServerError((response && response.error) ? response.error : 'Failed to create project.');
    }
  }

  // --- Project List (Step 4) ---
  function loadAdminProjectsList() {
    // if (!adminProjectListContainerEl) { // This check seems redundant if setupDOMReferences ensures it.
    //     console.warn("loadAdminProjectsList: adminProjectListContainerEl not ready yet.");
    //     return; 
    // }
    showLoading(true);
    google.script.run
      .withSuccessHandler(displayAdminProjects)
      .withFailureHandler(onServerError)
      .getAllProjectsForAdmin();
  }

  function displayAdminProjects(projectsArray) {
    showLoading(false);
    if (!adminProjectListContainerEl) {
        console.error("displayAdminProjects: adminProjectListContainerEl not found.");
        return;
    }
    adminProjectListContainerEl.innerHTML = ''; 
    if (!projectsArray || projectsArray.length === 0) {
      adminProjectListContainerEl.innerHTML = '<p>No projects found.</p>';
      return;
    }
    projectsArray.forEach(project => {
      if (!project || !project.projectId) return; 
      const projectItem = document.createElement('div');
      projectItem.className = 'project-item';
      const titleSpan = document.createElement('span');
      titleSpan.textContent = project.projectTitle || 'Untitled Project';
      const statusSpan = document.createElement('span');
      statusSpan.className = 'status';
      statusSpan.textContent = `(${project.status || 'N/A'})`;
      const titleAndStatusDiv = document.createElement('div');
      titleAndStatusDiv.appendChild(titleSpan);
      titleAndStatusDiv.appendChild(statusSpan);
      const editButton = document.createElement('button');
      editButton.textContent = 'Edit';
      editButton.className = 'edit-button'; 
      editButton.setAttribute('data-project-id', project.projectId); 
      editButton.onclick = function() { 
        switchToEditView(project.projectId); 
      };
      projectItem.appendChild(titleAndStatusDiv);
      projectItem.appendChild(editButton);
      adminProjectListContainerEl.appendChild(projectItem);
    });
  }

  // --- Image Upload Handling (Step 8) ---
  function handleImageUpload(event) {
    if (adminApp.state.isLoading) {
      displayMessage("Please wait for the current operation to complete.", false);
      if(event.target) event.target.value = null; 
      return;
    }
    const file = event.target.files[0];
    if (!file) {
      // displayMessage("No file selected.", false); // Can be noisy if user cancels
      return;
    }
    if (!file.type.startsWith('image/')) {
      displayMessage("Please select an image file.", false);
      if(event.target) event.target.value = null; 
      return;
    }

    showLoading(true);
    displayMessage("Uploading image...", true); 

    const reader = new FileReader();
    reader.onload = function(e) {
      const fileData = {
        fileName: file.name,
        mimeType: file.type,
        data: e.target.result.split(',')[1] 
      };
      
      if (!adminApp.state.currentProjectId) {
          showLoading(false);
          displayMessage("Error: No project selected for upload.", false);
          if(event.target) event.target.value = null; 
          return;
      }

      google.script.run
        .withSuccessHandler(onImageUploaded)
        .withFailureHandler(onServerError) 
        .uploadFileToDrive(fileData, adminApp.state.currentProjectId, 'image');
    };
    reader.onerror = function(error) {
        showLoading(false);
        displayMessage("Error reading file.", false);
        console.error("FileReader error: ", error);
        if(event.target) event.target.value = null; 
    };
    reader.readAsDataURL(file);
  }

  function onImageUploaded(response) { // response is from uploadFileToDrive
    showLoading(false);
    if (imageUploaderEl) imageUploaderEl.value = null; 

    if (response && response.success && response.driveFileId) { // Check for driveFileId now
      displayMessage("Image uploaded to Drive. Now fetching for canvas...", true);
      
      // Now call getImageAsBase64 with the driveFileId
      showLoading(true); // Show loading again for the fetch
      google.script.run
        .withSuccessHandler(onBase64ImageReceived)
        .withFailureHandler(onServerError) // onServerError already handles showLoading(false)
        .getImageAsBase64(response.driveFileId);

    } else {
      let errorMsg = "Failed to upload image to Drive or retrieve its ID.";
      if (response && response.error) {
        errorMsg = response.error;
      }
      onServerError({ message: errorMsg }); 
    }
  }

  // New success handler for getImageAsBase64
  function onBase64ImageReceived(response) {
    showLoading(false);
    if (response && response.success && response.base64Data) {
      if (!adminApp.state.fabricCanvasInstance) {
          displayMessage("Error: Canvas not initialized. Cannot set background.", false);
          return;
      }

      fabric.Image.fromURL(response.base64Data, function(img) {
        if (!adminApp.state.fabricCanvasInstance) {
            console.error("Canvas became unavailable before image could be set.");
            displayMessage("Error: Canvas became unavailable.", false);
            return;
        }

        const canvas = adminApp.state.fabricCanvasInstance;
        const imageNativeWidth = img.width;
        const imageNativeHeight = img.height;

        // --- DYNAMIC CANVAS RESIZING LOGIC (Max Width, Scrollable Height) ---
        const editorMaxWidth = 960; // Your desired maximum canvas width in the editor
        // const editorMaxHeightBeforeScroll = 700; // Optional: if you want to limit initial visible height before scroll

        let newCanvasWidth = imageNativeWidth;
        let newCanvasHeight = imageNativeHeight;
        const aspectRatio = imageNativeWidth / imageNativeHeight;

        // If image's native width is greater than our editor's max width, scale it down.
        if (newCanvasWidth > editorMaxWidth) {
          newCanvasWidth = editorMaxWidth;
          newCanvasHeight = Math.round(newCanvasWidth / aspectRatio); // Calculate height based on new width and original aspect ratio
        }
        // At this point, newCanvasWidth is <= editorMaxWidth.
        // newCanvasHeight is whatever height maintains the aspect ratio for that width.

        // 1. Resize the Fabric canvas logical surface
        canvas.setWidth(newCanvasWidth);
        canvas.setHeight(newCanvasHeight);
        console.log("Admin_JS: Canvas resized. New dimensions: " + newCanvasWidth + "x" + newCanvasHeight);

        // 2. Update the HTML canvas element's attributes for layout
        if (fabricCanvasEl) {
            fabricCanvasEl.width = newCanvasWidth;
            fabricCanvasEl.height = newCanvasHeight;
        }
        
        // 3. Ensure the container for the canvas can scroll if the canvas is too tall
        const canvasContainer = document.getElementById('fabricCanvasContainer');
        if (canvasContainer) {
            // Example: Allow vertical scrolling if canvas height exceeds a certain viewport or design height
            // This is more of a CSS concern for the container, but JS can set max-height if needed.
            // For now, we assume CSS on 'fabricCanvasContainer' or its parent handles overflow.
            // e.g., in AdminView.html CSS:
            // #fabricCanvasContainer { max-height: 700px; overflow-y: auto; /* other styles */ }
            console.log("Admin_JS: Canvas container should now accommodate new canvas size. Ensure its CSS allows scrolling if needed.");
        }

        // 4. Set the image as background.
        // The image will be scaled to fit the newCanvasWidth and newCanvasHeight.
        // Since we calculated these dimensions to maintain aspect ratio, the image will not be warped.
        canvas.setBackgroundImage(img, 
            canvas.renderAll.bind(canvas), {
              // Scale the original image to fit the new canvas dimensions
              scaleX: newCanvasWidth / imageNativeWidth,
              scaleY: newCanvasHeight / imageNativeHeight
            });
        
        canvas.renderAll();
        displayMessage("Image set as background. Canvas adjusted.", true);
        console.log("Image background set. Final canvas dimensions: " + canvas.width + "x" + canvas.height);

        // TODO in Step 9: Store newCanvasWidth, newCanvasHeight (the actual dimensions of THIS slide's canvas)
        // and driveFileId/mimeType in adminApp.state.projectData.slides[adminApp.state.currentSlideIndex]
        // These dimensions are what you'll use when re-loading this specific slide.
      }); 

    } else {
      let errorMsg = "Failed to fetch image data for canvas.";
      if (response && response.error) {
        errorMsg = response.error;
      }
      onServerError({ message: errorMsg });
    }
  }
</script>