<script>
    // Namespace for the viewer application
    window.viewerApp = {};

    // --- Global Variables ---
    const CLICK_AND_HOLD_DURATION = 750;
    const ANIMATION_SPEED_PRESETS = {
      slow: { duration: 1500 },
      normal: { duration: 1000 },
      fast: { duration: 500 }
    };

    // --- Application State ---
    viewerApp.state = {
      isLoading: false,
      currentProjectData: null,
      currentSlideIndex: 0,
      currentMediaType: null,
      viewerFabricCanvas: null,
      defaultCanvasWidth: 960,
      defaultCanvasHeight: 540,
      currentModalOverlay: null,
      modalSequence: [],
      currentModalSequenceIndex: -1,
      isSpotlightActive: false,
      currentSpotlightInfo: null,
      originalViewportTransform: null,
      isCanvasPannedOrZoomed: false,
      panZoomTargetObject: null, 
      activeAnimations: new Map(),
      currentVideoQuestions: [],
      askedQuestionIndices: [],
      videoOverlays: [],
      activeOverlays: new Map(),
      imageSlideTimelineEvents: [],
      currentImageSlideEventIndex: -1,
      currentImageTimelineEvents: []
    };

    // --- DOM Element References ---
    let viewerProjectListContainerEl, messageAreaElViewer, loadingSpinnerElViewer;
    let viewerListViewContainerEl, viewerProjectDisplayAreaEl, viewingProjectTitleEl;
    let viewerMediaContainerEl, youtubePlayerContainerEl, viewerAudioPlayerEl;
    let viewerCanvasContainerEl, viewerFabricCanvasEl;
    let viewerPrevSlideButtonEl, viewerNextSlideButtonEl, viewerSlideIndicatorEl, backToViewerListButtonEl;
    let viewerModalEl, viewerModalCloseButtonEl, viewerModalBodyEl,
        modalPrevButtonEl, modalNextButtonEl;

    let viewerTimelineTrackEl, viewerTimelineProgressEl,
        viewerCurrentTimeEl, viewerTotalDurationEl;

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', function() {
      console.log("Viewer_JS: DOMContentLoaded event fired!");
      viewerApp.setupDOMReferences();
      viewerApp.attachEventListeners();
      loadViewerProjectsList();
      console.log("Viewer_JS: Initialization complete.");
    });

    viewerApp.setupDOMReferences = function() {
      viewerProjectListContainerEl = document.getElementById('viewerProjectListContainer');
      messageAreaElViewer = document.getElementById('messageAreaViewer');
      loadingSpinnerElViewer = document.getElementById('loadingSpinner');
      viewerListViewContainerEl = document.getElementById('viewerListViewContainer');
      viewerProjectDisplayAreaEl = document.getElementById('viewerProjectDisplayArea');
      viewingProjectTitleEl = document.getElementById('viewingProjectTitle');
      viewerMediaContainerEl = document.getElementById('viewerMediaContainer');
      youtubePlayerContainerEl = document.getElementById('youtubePlayerContainer');
      viewerAudioPlayerEl = document.getElementById('viewerAudioPlayer');
      viewerCanvasContainerEl = document.getElementById('viewerCanvasContainer');
      viewerFabricCanvasEl = document.getElementById('viewerFabricCanvas');
      viewerPrevSlideButtonEl = document.getElementById('viewerPrevSlideButton');
      viewerNextSlideButtonEl = document.getElementById('viewerNextSlideButton');
      viewerSlideIndicatorEl = document.getElementById('viewerSlideIndicator');
      backToViewerListButtonEl = document.getElementById('backToViewerListButton');
      viewerModalEl = document.getElementById('viewerModal');
      viewerModalCloseButtonEl = document.getElementById('viewerModalCloseButton');
      viewerModalBodyEl = document.getElementById('viewerModalBody');
      modalPrevButtonEl = document.getElementById('modalPrevButton');
      modalNextButtonEl = document.getElementById('modalNextButton');
      viewerTimelineTrackEl = document.getElementById('viewerTimelineTrack'); 
      viewerTimelineProgressEl = document.getElementById('viewerTimelineProgress');
      viewerCurrentTimeEl = document.getElementById('viewerCurrentTime');
      viewerTotalDurationEl = document.getElementById('viewerTotalDuration');
      viewerApp.dom = viewerApp.dom || {};
      viewerApp.dom.viewerPrevImageEventButtonEl = document.getElementById('viewerPrevImageEventButton');
      viewerApp.dom.viewerImageEventIndicatorEl = document.getElementById('viewerImageEventIndicator');
      viewerApp.dom.viewerNextImageEventButtonEl = document.getElementById('viewerNextImageEventButton');
      if (!viewerProjectDisplayAreaEl) console.error("CRITICAL: viewerProjectDisplayAreaEl not found!");
      console.log("Viewer_JS: DOM references set up.");
    };

    viewerApp.attachEventListeners = function() {
        if (backToViewerListButtonEl) backToViewerListButtonEl.addEventListener('click', showProjectListView);
        if (viewerPrevSlideButtonEl) viewerPrevSlideButtonEl.addEventListener('click', navigateToPrevSlide);
        if (viewerNextSlideButtonEl) viewerNextSlideButtonEl.addEventListener('click', navigateToNextSlide);
        if (viewerModalCloseButtonEl) viewerModalCloseButtonEl.addEventListener('click', hideViewerModal);
        if (viewerModalEl) {
            viewerModalEl.addEventListener('click', function(event) {
                if (event.target === viewerModalEl) hideViewerModal();
            });
        }
        if (modalPrevButtonEl) modalPrevButtonEl.addEventListener('click', navigateModalPrevious);
        if (modalNextButtonEl) modalNextButtonEl.addEventListener('click', navigateModalNext);
        if (viewerApp.dom.viewerPrevImageEventButtonEl) viewerApp.dom.viewerPrevImageEventButtonEl.addEventListener('click', navigateToPrevImageEvent);
        if (viewerApp.dom.viewerNextImageEventButtonEl) viewerApp.dom.viewerNextImageEventButtonEl.addEventListener('click', navigateToNextImageEvent);

        if (viewerTimelineTrackEl) {
            viewerTimelineTrackEl.addEventListener('click', function(e) {
                const mediaType = viewerApp.state.currentMediaType;
                let duration = 0;
                let playerInstance = null;

                if (mediaType === 'youtube' && mediaManager.state.ytPlayer) {
                    duration = mediaManager.state.currentVideoDuration;
                    playerInstance = mediaManager.state.ytPlayer;
                } else if (mediaType === 'audio' && mediaManager.state.audioPlayer) {
                    duration = mediaManager.state.currentAudioDuration;
                    playerInstance = mediaManager.state.audioPlayer;
                }

                if (playerInstance && duration > 0) {
                    const rect = viewerTimelineTrackEl.getBoundingClientRect();
                    const clickX = e.clientX - rect.left;
                    const percentage = clickX / rect.width;
                    const seekTime = percentage * duration;

                    if (mediaType === 'youtube' && typeof playerInstance.seekTo === 'function') {
                        playerInstance.seekTo(seekTime, true);
                    } else if (mediaType === 'audio' && typeof playerInstance.currentTime !== 'undefined') { // Check if currentTime is a valid property
                        playerInstance.currentTime = seekTime;
                    }
                }
            });
        }
        document.addEventListener('keydown', function(event) { /* ... existing keyboard nav logic ... */ });
    };

    let _optimizedRenderRAFId = null;
    function optimizedRenderAll(canvasInstance) { if (!canvasInstance) return; if (_optimizedRenderRAFId) { fabric.util.cancelAnimFrame(_optimizedRenderRAFId); } _optimizedRenderRAFId = fabric.util.requestAnimFrame(() => { canvasInstance.renderAll(); _optimizedRenderRAFId = null; }, canvasInstance.getElement()); }
    function smoothAnimate(drawCallback, duration = 300, easingFunction = easeInOutQuad) { /* ... content ... */ }
    function easeInOutQuad(t) { return t < 0.5 ? 2 * t * t : -1 + (4 - 2 * t) * t; }
    optimizedRenderAll = window.sharedUtils ? window.sharedUtils.debounce(optimizedRenderAll, 50) : optimizedRenderAll;

    function loadViewerProjectsList() {
      console.log("loadViewerProjectsList called");
      if (!google || !google.script || !google.script.run) {
        baseApp.displayMessage("Error: Client-server communication bridge unavailable.", false, 'messageAreaViewer'); return;
      }
      if (!viewerProjectListContainerEl) {
          // baseApp.showLoading(false, 'loadingSpinner'); // Spinner might not have been shown yet
          console.warn("loadViewerProjectsList: viewerProjectListContainerEl not found. Cannot display projects.");
          return;
      }
      baseApp.showLoading(true, 'loadingSpinner');
      viewerApp.state.isLoading = true;
      google.script.run
        .withSuccessHandler(displayViewerProjects)
        .withFailureHandler(error => baseApp.onServerError(error, 'messageAreaViewer')) // onServerError now handles isLoading=false
        .getActiveProjectsList();
    }

    function displayViewerProjects(response) {
        baseApp.showLoading(false, 'loadingSpinner'); // Handled by onServerError too, but good for success path
        viewerApp.state.isLoading = false;
        if (!response || !response.success) {
            // Error already handled by withFailureHandler calling baseApp.onServerError
            // baseApp.onServerError(response || { error: "Failed to load projects" }, 'messageAreaViewer');
            return;
        }
        const projectsArray = response.data && response.data.projects ? response.data.projects : [];
        if (!viewerProjectListContainerEl) { console.error("displayViewerProjects: viewerProjectListContainerEl is not found!"); return; }
        viewerProjectListContainerEl.innerHTML = '';
        if (!projectsArray || projectsArray.length === 0) {
          viewerProjectListContainerEl.innerHTML = '<p>No active training modules found at this time.</p>'; return;
        }
          const ul = document.createElement('ul');
          ul.className = 'project-list-viewer';
          projectsArray.forEach(project => {
            if (!project || !project.projectId) { console.warn("Skipping display of invalid project object:", project); return; }
            const listItem = document.createElement('li'); listItem.className = 'project-card-viewer';
            const titleHeader = document.createElement('h3'); titleHeader.textContent = project.projectTitle || 'Untitled Project';
            const viewButton = document.createElement('button'); viewButton.textContent = 'View Project'; viewButton.className = 'view-project-button';
            viewButton.setAttribute('data-project-id', project.projectId);
            viewButton.onclick = function() { loadProjectForViewing(project.projectId); };
            listItem.appendChild(titleHeader); listItem.appendChild(viewButton); ul.appendChild(listItem);
          });
          viewerProjectListContainerEl.appendChild(ul);
    }

    function showProjectListView() {
        if (viewerListViewContainerEl) viewerListViewContainerEl.style.display = 'block';
        if (viewerProjectDisplayAreaEl) viewerProjectDisplayAreaEl.style.display = 'none';
        if (typeof mediaManager !== 'undefined') {
            if (mediaManager.stopAndDestroyPlayer) mediaManager.stopAndDestroyPlayer();
            if (mediaManager.stopAndClearAudioPlayer) mediaManager.stopAndClearAudioPlayer();
        }
        hideSpotlightSVG();
        if(viewerApp.state.isCanvasPannedOrZoomed) resetPanZoomWithAnimation(true);
        if (viewerApp.state.viewerFabricCanvas) {
            viewerApp.state.viewerFabricCanvas.dispose(); viewerApp.state.viewerFabricCanvas = null;
        }
        viewerApp.state.currentProjectData = null; viewerApp.state.currentSlideIndex = 0;
        // messageAreaElViewer might need clearing if returning to list view with a persistent message
        // However, loadViewerProjectsList will likely display a new message or clear it if successful (no projects).
        loadViewerProjectsList();
    }

    function showProjectView() { /* ... content ... */ }

    function loadProjectForViewing(projectId) {
      if (!projectId) {
        baseApp.displayMessage("Invalid project ID.", false, 'messageAreaViewer');
        return;
      }
      baseApp.showLoading(true, 'loadingSpinner');
      viewerApp.state.isLoading = true;
      google.script.run
        .withSuccessHandler(onProjectViewDataReceived)
        .withFailureHandler(error => baseApp.onServerError(error, 'messageAreaViewer'))
        .getProjectViewById(projectId);
    }

    function onProjectViewDataReceived(response) {
      baseApp.showLoading(false, 'loadingSpinner');
      viewerApp.state.isLoading = false;
      if (!response || !response.success || !response.data || !response.data.projectDataJSON) {
        baseApp.onServerError(response || { error: "Failed to load project data." }, 'messageAreaViewer');
        viewerApp.state.currentProjectData = null;
        return;
      }
      try {
        const projectData = JSON.parse(response.data.projectDataJSON);
        if (!projectData.slides || projectData.slides.length === 0) {
          baseApp.displayMessage("This project has no slides.", false, 'messageAreaViewer');
          viewerApp.state.currentProjectData = null;
          return;
        }
        viewerApp.state.currentProjectData = projectData;
        viewerApp.state.currentSlideIndex = 0;
        if (viewingProjectTitleEl) viewingProjectTitleEl.textContent = projectData.title || 'Untitled Project';

        if (!viewerApp.state.viewerFabricCanvas && viewerFabricCanvasEl) {
            initializeViewerCanvas();
        }

        renderSlideForViewing(0);
        showProjectView(); // Ensure this is called after canvas is potentially initialized
      } catch (e) {
        console.error("Error parsing project data:", e);
        baseApp.onServerError({ message: "Error processing project data." }, 'messageAreaViewer');
        viewerApp.state.currentProjectData = null;
      }
    }

    function getCurrentSlide() { /* ... content ... */ }
    function getActionButtonText(action) { /* ... content ... */ }
    function createOverlayElement(overlay) { /* ... content, use mediaManager.getTemplateColor ... */ }
    function applyTemplateStyles(element, overlay) { /* ... content, use mediaManager.getTemplateColor ... */ }
    function handleOverlayAction(overlay) { /* ... content ... */ }
    function dismissOverlay(overlayId) { /* ... content, ensure mediaManager.state.ytPlayer or audioPlayer is used for play/pause ... */ }
    function initializeVideoOverlays() { /* ... content ... */ }
    function clearOverlayDisplayArea() { /* ... content ... */ }
    
    // --- MediaManager Callbacks for Viewer ---
    viewerApp.handleMediaPlayerReady = function(event) { // For YouTube
        console.log("ViewerApp: YouTube Player Ready.");
        const currentSlide = getCurrentSlide();
        if (currentSlide && currentSlide.slideMedia && currentSlide.slideMedia.type === 'youtube' &&
            currentSlide.slideMedia.youtubeOptions && currentSlide.slideMedia.youtubeOptions.showClickToBeginButton) {
            if (viewerApp.state.viewerFabricCanvas && viewerCanvasContainerEl && viewerFabricCanvasEl) {
                viewerCanvasContainerEl.style.pointerEvents = 'auto';
                viewerFabricCanvasEl.style.opacity = '1';
                const canvas = viewerApp.state.viewerFabricCanvas;
                canvas.getObjects().forEach(obj => { if (obj.customType === 'clickToBeginButton') canvas.remove(obj); });
                const beginButtonText = new fabric.Textbox('Click here to begin', {
                    left: canvas.width / 2, top: canvas.height / 2, originX: 'center', originY: 'center',
                    fontSize: (canvas.width > 600 ? 30 : 24), fill: 'white',
                    backgroundColor: 'rgba(0,0,0,0.8)',padding: 20, rx: 10, ry: 10,
                    selectable: false, evented: true, hoverCursor: 'pointer',customType: 'clickToBeginButton'
                });
                beginButtonText.on('mousedown', function() {
                    if (mediaManager.state.ytPlayer && typeof mediaManager.state.ytPlayer.playVideo === 'function') mediaManager.state.ytPlayer.playVideo();
                    canvas.remove(this); updateViewerCanvasInteractivity();
                });
                canvas.add(beginButtonText); canvas.bringToFront(beginButtonText); canvas.renderAll();
            }
        }
        viewerApp.renderTimelineMarkers();
        updateViewerCanvasInteractivity();
    };

    viewerApp.handleAudioPlayerReady = function(event) { // For Audio
        console.log("ViewerApp: Audio Player Ready.");
        viewerApp.renderTimelineMarkers();
        updateViewerCanvasInteractivity();
    };

    viewerApp.handleMediaPlayerStateChange = function(event) { // For YouTube
        console.log("ViewerApp: YouTube Player State Change:", event.data);
        updateViewerCanvasInteractivity();
    };

    viewerApp.handleMediaPlayerError = function(eventData) { // For YouTube
        baseApp.displayMessage(`YouTube Player Error: Code ${eventData.errorData}`, false, 'messageAreaViewer');
        updateViewerCanvasInteractivity();
    };

    viewerApp.handleAudioPlayerError = function(eventData) { // For Audio
        baseApp.displayMessage('Error playing audio: ' + (eventData.error ? eventData.error.message : 'Unknown error'), false, 'messageAreaViewer');
        updateViewerCanvasInteractivity();
    };

    viewerApp.handleMediaTimeUpdate = function(currentTime, duration) {
        if (viewerCurrentTimeEl) viewerCurrentTimeEl.textContent = sharedUtils.formatTime(currentTime);
        if (viewerTotalDurationEl) viewerTotalDurationEl.textContent = sharedUtils.formatTime(duration);
        if (viewerTimelineProgressEl && duration > 0) {
            viewerTimelineProgressEl.style.width = (currentTime / duration) * 100 + '%';
        }
    };

    viewerApp.handleMediaQuestionTrigger = function(currentTime) {
        const currentSlide = getCurrentSlide();
        if (!currentSlide || !currentSlide.slideMedia || currentSlide.slideMedia.type !== 'youtube' || !currentSlide.slideMedia.videoQuestions || currentSlide.slideMedia.videoQuestions.length === 0) {
            return;
        }
        for (let i = 0; i < currentSlide.slideMedia.videoQuestions.length; i++) {
            const question = currentSlide.slideMedia.videoQuestions[i];
            if (!viewerApp.state.askedQuestionIndices.includes(i) && currentTime >= question.timestamp && currentTime < question.timestamp + 1.5) {
                if (mediaManager.state.ytPlayer && typeof mediaManager.state.ytPlayer.pauseVideo === 'function') {
                    mediaManager.state.ytPlayer.pauseVideo();
                }
                viewerApp.state.askedQuestionIndices.push(i);
                viewerApp.displayQuestion(question);
                break;
            }
        }
    };

    viewerApp.handleMediaOverlayUpdate = function(currentTime) {
        viewerApp.updateVideoOverlays(currentTime);
    };

    viewerApp.handleMediaEnded = function(mediaTypeInfo) {
        console.log(`ViewerApp: ${mediaTypeInfo.type} media ended.`);
        if (mediaTypeInfo.type === 'youtube') {
            viewerApp.state.askedQuestionIndices = [];
        }
    };

    function initializeViewerCanvas() { /* ... content as before, ensure no media player direct access ... */ }

    function renderSlideForViewing(slideIndex) {
        if (!viewerApp.state.currentProjectData || !viewerApp.state.viewerFabricCanvas) return;
        const slides = viewerApp.state.currentProjectData.slides;
        if (slideIndex < 0 || slideIndex >= slides.length) return;

        if (typeof mediaManager !== 'undefined') {
            if (mediaManager.stopAndDestroyPlayer) mediaManager.stopAndDestroyPlayer();
            if (mediaManager.stopAndClearAudioPlayer) mediaManager.stopAndClearAudioPlayer();
        }
        hideSpotlightSVG(); 
        if(viewerApp.state.isCanvasPannedOrZoomed) resetPanZoomWithAnimation(true);

        const slideData = slides[slideIndex];
        const canvas = viewerApp.state.viewerFabricCanvas;
        viewerApp.state.currentSlideIndex = slideIndex;
        viewerApp.state.currentMediaType = (slideData.slideMedia && slideData.slideMedia.type) ? slideData.slideMedia.type : 'none';
        viewerApp.state.askedQuestionIndices = [];
        viewerApp.state.currentImageEventIndex = 0;
        viewerApp.state.currentImageTimelineEvents = (slideData.timelineEvents && Array.isArray(slideData.timelineEvents)) ? slideData.timelineEvents : [];

        const isImageWithTimeline = viewerApp.state.currentMediaType === 'image' && viewerApp.state.currentImageTimelineEvents.length > 0;
        // ... (UI updates for nav buttons as before) ...

        const interactiveTimelineBar = document.getElementById('interactiveTimelineBar');
        sharedUtils.safeDOMUpdate(interactiveTimelineBar, el => el.style.display = (viewerApp.state.currentMediaType === 'youtube' || viewerApp.state.currentMediaType === 'audio') ? 'block' : 'none');
        
        initializeVideoOverlays();

        if (canvas) {
            canvas.getObjects().forEach(obj => {
                if (obj.customType === 'videoTimestampOverlay' || obj.isTimestampOverlay) canvas.remove(obj);
            });
        }

        if (!slideData.slideMedia) slideData.slideMedia = { type: null, url: null, driveFileId: null, mimeType: null, originalName: null, youtubeOptions: { showClickToBeginButton: false } };
        else if (slideData.slideMedia.type === 'youtube' && typeof slideData.slideMedia.youtubeOptions === 'undefined') slideData.slideMedia.youtubeOptions = { showClickToBeginButton: false };

        const slideWidth = slideData.canvasWidth || viewerApp.state.defaultCanvasWidth;
        const slideHeight = slideData.canvasHeight || viewerApp.state.defaultCanvasHeight;
        canvas.setWidth(slideWidth); canvas.setHeight(slideHeight);
        if (viewerFabricCanvasEl) { viewerFabricCanvasEl.width = slideWidth; viewerFabricCanvasEl.height = slideHeight; }
        if (viewerMediaContainerEl) { viewerMediaContainerEl.style.width = slideWidth + 'px'; viewerMediaContainerEl.style.height = slideHeight + 'px'; }
        canvas.clear(); canvas.setBackgroundImage(null, () => { canvas.renderAll(); }); canvas.backgroundColor = 'transparent';

        const media = slideData.slideMedia;
        sharedUtils.safeDOMUpdate(youtubePlayerContainerEl, el => el.style.display = 'none');
        sharedUtils.safeDOMUpdate(viewerAudioPlayerEl, el => el.style.display = 'none');
        sharedUtils.safeDOMUpdate(viewerCanvasContainerEl, el => el.style.display = 'flex');

        console.log(`Rendering slide ${slideIndex + 1}, media type: ${viewerApp.state.currentMediaType}`);

        switch(viewerApp.state.currentMediaType) {
            case 'image':
                sharedUtils.safeDOMUpdate(viewerMediaContainerEl, el => el.style.backgroundColor = '#333');
                sharedUtils.safeDOMUpdate(viewerFabricCanvasEl, el => el.style.opacity = '1');
                sharedUtils.safeDOMUpdate(viewerCanvasContainerEl, el => el.style.pointerEvents = 'auto');
                // ... (image loading logic, ensure baseApp.showLoading/onServerError used) ...
                break;
             case 'youtube':
                sharedUtils.safeDOMUpdate(viewerMediaContainerEl, el => el.style.backgroundColor = 'transparent');
                canvas.backgroundColor = 'rgba(0,0,0,0)';
                const videoId = sharedUtils.extractYouTubeVideoId(media.url);
                if (videoId && youtubePlayerContainerEl) {
                    sharedUtils.safeDOMUpdate(youtubePlayerContainerEl, el => { el.innerHTML = '<div id="youtube-player-div" style="width: 100%; height: 100%;"></div>'; el.style.display = 'block';});
                    
                    const playerVars = { 'autoplay': 0, 'controls': 0, 'rel': 0, 'showinfo': 0, 'modestbranding': 1, 'iv_load_policy': 3, 'fs': 0, 'disablekb': 1, 'playsinline': 1 };
                    const eventHandlers = { 'onReady': mediaManager.onPlayerReady, 'onStateChange': mediaManager.onPlayerStateChange, 'onError': mediaManager.onPlayerError };
                    
                    mediaManager.state.callbacks.onReady = viewerApp.handleMediaPlayerReady;
                    mediaManager.state.callbacks.onStateChange = viewerApp.handleMediaPlayerStateChange;
                    mediaManager.state.callbacks.onError = viewerApp.handleMediaPlayerError;
                    mediaManager.state.callbacks.onTimeUpdate = viewerApp.handleMediaTimeUpdate;
                    mediaManager.state.callbacks.onQuestionTrigger = viewerApp.handleMediaQuestionTrigger;
                    mediaManager.state.callbacks.onOverlayUpdateNeeded = viewerApp.handleMediaOverlayUpdate;
                    mediaManager.state.callbacks.onEnded = viewerApp.handleMediaEnded;
                    
                    mediaManager.setupPlayer(videoId, 'youtube-player-div', playerVars, eventHandlers);
                } else {
                    baseApp.displayMessage("Invalid YouTube URL.", false, 'messageAreaViewer');
                }
                updateViewerCanvasInteractivity();
                break;
             case 'audio':
                sharedUtils.safeDOMUpdate(viewerMediaContainerEl, el => el.style.backgroundColor = '#333');
                sharedUtils.safeDOMUpdate(interactiveTimelineBar, el => el.style.display = 'block');
                if (media && media.driveFileId) {
                    baseApp.showLoading(true, 'loadingSpinner');
                    viewerApp.state.isLoading = true; // Manage isLoading state
                    google.script.run
                        .withSuccessHandler(function(audioResponse) {
                            baseApp.showLoading(false, 'loadingSpinner');
                            viewerApp.state.isLoading = false; // Manage isLoading state
                            if (viewerApp.state.currentSlideIndex !== slideIndex) return;
                            if (audioResponse && audioResponse.success && audioResponse.base64Data) {
                                const audioEventHandlers = {
                                    'onLoadedMetadata': mediaManager.onAudioLoadedMetadata,
                                    'onEnded': mediaManager.onAudioEnded,
                                    'onError': mediaManager.onAudioError
                                };
                                mediaManager.state.callbacks.onReady = viewerApp.handleAudioPlayerReady;
                                mediaManager.state.callbacks.onError = viewerApp.handleAudioPlayerError;
                                mediaManager.state.callbacks.onTimeUpdate = viewerApp.handleMediaTimeUpdate;
                                mediaManager.state.callbacks.onOverlayUpdateNeeded = viewerApp.handleMediaOverlayUpdate;
                                mediaManager.state.callbacks.onEnded = viewerApp.handleMediaEnded;

                                mediaManager.setupAudio(audioResponse.base64Data, 'viewerAudioPlayer', audioEventHandlers);

                                if (slideData.fabricCanvasJSON) { /* ... load fabric ... */ } else { canvas.renderAll(); }
                            } else { 
                               baseApp.onServerError(audioResponse || {error: "Failed to load audio data."}, 'messageAreaViewer');
                               canvas.renderAll();
                            }
                        })
                        .withFailureHandler(error => {
                            // baseApp.showLoading(false, 'loadingSpinner'); // Handled by onServerError
                            // viewerApp.state.isLoading = false; // Handled by onServerError
                            baseApp.onServerError(error, 'messageAreaViewer');
                            canvas.renderAll();
                        })
                        .getAudioAsBase64(media.driveFileId);
                } else { canvas.renderAll(); }
                updateViewerCanvasInteractivity();
                break;
             default:
                updateViewerCanvasInteractivity();
                break;
        }
        updateSlideNavigationUI();
    }
    
    viewerApp.renderTimelineMarkers = function() {
        const mediaType = viewerApp.state.currentMediaType;
        let duration; let questions = [];
        const overlays = viewerApp.state.videoOverlays || [];

        if (mediaType === 'youtube') {
            duration = mediaManager.state.currentVideoDuration;
            const currentSlide = getCurrentSlide();
            if (currentSlide && currentSlide.slideMedia) questions = currentSlide.slideMedia.videoQuestions || [];
        } else if (mediaType === 'audio') {
            duration = mediaManager.state.currentAudioDuration;
        } else {
            if(viewerTimelineTrackEl) viewerTimelineTrackEl.innerHTML = '';
            return;
        }
        mediaManager.renderTimelineMarkers('viewerTimelineTrack', questions, overlays);
    };

    viewerApp.displayQuestion = function(question) { /* ... existing displayQuestion logic ... */ };
    viewerApp.updateVideoOverlays = function(currentTime) {
        // This function now receives currentTime from MediaManager
        // Removed direct calls to isYouTubePlayerAvailable or safeGetCurrentTime
        // Uses viewerApp.state.videoOverlays (DOM overlay definitions)
        // ... existing logic to show/hide/update DOM overlays based on currentTime ...
    };

    // renderImageTimelineEvent, updateImageTimelineNavUI, navigateToPrevImageEvent, navigateToNextImageEvent
    // handleOverlayInteraction, executeAnimation, and animation helpers
    // Modal functions, Spotlight functions, updateSlideNavigationUI, resetTimeline
    // updateViewerCanvasInteractivity - all remain, ensure they use MediaManager state where appropriate.
    // For example, direct player access like viewerApp.state.ytPlayer.pauseVideo() becomes mediaManager.state.ytPlayer.pauseVideo()
    // or better, via a MediaManager function like mediaManager.pauseVideo() if created.
    // The timeline click listener was updated to use mediaManager.state.
  </script>
