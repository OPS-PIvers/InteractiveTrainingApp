<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title><?= project.title ?> - Interactive Training</title>
  
  <?!= include('Common'); ?>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
  
  <style>
    /* Common styles */
    body {
      overflow: hidden;
      margin: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    
    /* Header styles */
    .app-header {
      padding: 0.5rem 1rem;
      background-color: var(--primary-color);
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }
    
    .app-title {
      margin: 0;
      font-size: 1.2rem;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .app-actions {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      flex-shrink: 0;
    }
    
    /* Tab navigation */
    .view-tabs {
      display: flex;
      background-color: #f8f9fa;
      border-bottom: 1px solid var(--border-color);
      flex-shrink: 0;
    }
    
    .view-tab {
      padding: 0.75rem 1.5rem;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
      border-bottom: 3px solid transparent;
    }
    
    .view-tab.active {
      border-bottom-color: var(--primary-color);
      color: var(--primary-color);
    }
    
    .view-tab:hover:not(.active) {
      border-bottom-color: #ddd;
    }
    
    /* View containers */
    .view-container {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    /* Import editor-specific styles */
    <?!= include('EditorStyles'); ?>
    
    /* Import viewer-specific styles */
    <?!= include('ViewerStyles'); ?>
    
    /* Hide elements */
    .hidden {
      display: none !important;
    }
    
    /* Analytics panel */
    .analytics-panel {
      position: fixed;
      right: 0;
      top: 0;
      width: 300px;
      height: 100vh;
      background: white;
      border-left: 1px solid var(--border-color);
      z-index: 1000;
      transform: translateX(100%);
      transition: transform 0.3s ease;
      box-shadow: -2px 0 5px rgba(0,0,0,0.1);
    }
    
    .analytics-panel.visible {
      transform: translateX(0);
    }
    
    .analytics-toggle {
      position: absolute;
      left: -40px;
      top: 50%;
      transform: translateY(-50%);
      background: var(--primary-color);
      color: white;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border-radius: 4px 0 0 4px;
    }
  </style>
</head>
<body>
  <div id="alertContainer" style="display: none; position: fixed; top: 10px; right: 10px; z-index: 1000;"></div>
  
  <!-- Project data store -->
  <div id="projectData" data-project='<?= JSON.stringify(project) ?>' style="display: none;"></div>
  
  <!-- App header -->
  <div class="app-header">
    <h1 id="appTitle" class="app-title"><?= project.title ?></h1>
    <div class="app-actions">
      <?if (canEdit) { ?>
        <button id="saveButton" class="btn btn-sm">Save</button>
      <? } ?>
      <?if (isAdmin) { ?>
        <button id="settingsButton" class="btn btn-secondary btn-sm">Settings</button>
      <? } ?>
      <button id="backToProjectsButton" class="btn btn-secondary btn-sm">Back</button>
    </div>
  </div>
  
  <!-- View tabs navigation -->
  <div class="view-tabs">
    <div id="viewerTab" class="view-tab active">View</div>
    <?if (canEdit) { ?>
      <div id="editorTab" class="view-tab">Edit</div>
    <? } ?>
    <?if (canEdit) { ?>
      <div id="analyticsTab" class="view-tab">Analytics</div>
    <? } ?>
  </div>
  
  <!-- Viewer container -->
  <div id="viewerContainer" class="view-container">
    <!-- Viewer content here -->
    <div class="viewer-content">
      <div class="slides-navigation">
        <button id="prevSlideBtn" class="nav-button">Previous</button>
        <span id="slideCounter">Slide 1 of 10</span>
        <button id="nextSlideBtn" class="nav-button">Next</button>
      </div>
      
      <div class="slide-display-area">
        <div id="slideCanvas">
          <!-- Slide content rendered here -->
          <div class="loading-placeholder">Loading slide content...</div>
        </div>
      </div>
      
      <div class="viewer-controls">
        <div class="progress-bar">
          <div class="progress-fill" style="width: 10%;"></div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Editor container -->
  <div id="editorContainer" class="view-container hidden">
    <!-- Editor toolbar -->
    <div class="toolbar" id="editor-toolbar">
      <button class="btn btn-secondary" id="btnAddSlide" title="Add Slide">
        <span class="tooltip">‚ûï Slide<span class="tooltip-text">Add a new slide</span></span>
      </button>
      <div class="toolbar-separator"></div>
      
      <button class="btn btn-secondary" id="btnRectangle" title="Add Rectangle">
        <span class="tooltip">‚ñ≠<span class="tooltip-text">Add rectangle shape</span></span>
      </button>
      <button class="btn btn-secondary" id="btnCircle" title="Add Circle">
        <span class="tooltip">‚óã<span class="tooltip-text">Add circle shape</span></span>
      </button>
      <button class="btn btn-secondary" id="btnText" title="Add Text">
        <span class="tooltip">T<span class="tooltip-text">Add text element</span></span>
      </button>
      <button class="btn btn-secondary" id="btnHotspot" title="Add Hotspot">
         <span class="tooltip">üéØ<span class="tooltip-text">Add interactive hotspot</span></span>
      </button>
      <button class="btn btn-secondary" id="btnArrow" title="Add Arrow">
         <span class="tooltip">‚Üí<span class="tooltip-text">Add arrow shape</span></span>
      </button>
      
      <div class="toolbar-separator"></div>
      
      <button class="btn btn-secondary" id="btnUploadImage" title="Add Image">
        <span class="tooltip">üñºÔ∏è Image<span class="tooltip-text">Upload an image</span></span>
      </button>
      <button class="btn btn-secondary" id="btnMedia" title="Add Video/Audio">
         <span class="tooltip">üé¨ Media<span class="tooltip-text">Add video or audio</span></span>
      </button>
      
      <div class="toolbar-separator"></div>
      
      <button class="btn btn-secondary" id="btnDelete" title="Delete Selected">
         <span class="tooltip">üóëÔ∏è Delete<span class="tooltip-text">Delete selected element(s)</span></span>
      </button>
      <button class="btn btn-secondary" id="btnCopy" title="Copy Selected">
         <span class="tooltip">üìÑ Copy<span class="tooltip-text">Copy selected element(s)</span></span>
      </button>
      <button class="btn btn-secondary" id="btnPaste" title="Paste">
         <span class="tooltip">üìã Paste<span class="tooltip-text">Paste copied element(s)</span></span>
      </button>
      <button class="btn btn-secondary" id="btnDuplicate" title="Duplicate Selected">
         <span class="tooltip">‚ûï Duplicate<span class="tooltip-text">Duplicate selected element(s)</span></span>
      </button>
      
      <div class="toolbar-separator"></div>
      
      <button class="btn btn-secondary" id="btnBringForward" title="Bring Forward">
         <span class="tooltip">üîº Forward<span class="tooltip-text">Bring forward</span></span>
      </button>
      <button class="btn btn-secondary" id="btnSendBackward" title="Send Backward">
         <span class="tooltip">üîΩ Backward<span class="tooltip-text">Send backward</span></span>
      </button>
    </div>
    
    <!-- Editor main area -->
    <div class="editor-container">
      <div class="slides-panel" id="slides-panel">
        <div class="slides-header">
          <h3>Slides</h3>
          <button id="addSlideButton" class="btn btn-secondary btn-sm" title="Add New Slide">‚ûï</button>
        </div>
        <div id="slides-list">
          <p style="text-align: center; color: #aaa; font-size: 0.9em; padding: 10px;">Loading slides...</p>
        </div>
      </div>
      
      <div class="canvas-panel" id="canvas-panel">
        <div class="canvas-scaler"> 
          <canvas id="editor-canvas">
            Your browser does not support the canvas element.
          </canvas>
        </div>
      </div>
      
      <div class="properties-panel" id="properties-panel">
        <h3>Properties</h3>
        <div id="no-selection-message">
          <p>Select an element on the canvas to edit its properties.</p>
        </div>
        <div id="properties-container" style="display:none;"></div>
      </div>
    </div>
    
    <!-- Timeline panel -->
    <div class="timeline-panel" id="timeline-panel" style="display: none;"> 
      <div class="timeline-controls">
        <button id="playButton" class="btn btn-secondary btn-sm">Play</button>
        <div class="timeline-time" id="current-time">00:00.000</div>
        <div id="timeline-ruler">
          <div id="timeline-playhead"></div>
        </div>
        <div class="timeline-time" id="total-time">00:00.000</div>
      </div>
      <div id="timeline-tracks"></div>
    </div>
  </div>
  
  <!-- Analytics container -->
  <div id="analyticsContainer" class="view-container hidden">
    <!-- Analytics content here -->
    <div class="analytics-dashboard">
      <div class="analytics-header">
        <h2>Project Analytics</h2>
        <div class="date-range-selector">
          <label for="dateRange">Date Range:</label>
          <select id="dateRange" class="form-control">
            <option value="7d">Last 7 days</option>
            <option value="30d">Last 30 days</option>
            <option value="90d">Last 90 days</option>
            <option value="all">All time</option>
          </select>
        </div>
      </div>
      
      <div class="analytics-summary">
        <div class="metric-card">
          <h3>Total Views</h3>
          <div class="metric-value">0</div>
        </div>
        <div class="metric-card">
          <h3>Completion Rate</h3>
          <div class="metric-value">0%</div>
        </div>
        <div class="metric-card">
          <h3>Avg. Score</h3>
          <div class="metric-value">N/A</div>
        </div>
        <div class="metric-card">
          <h3>Avg. Time</h3>
          <div class="metric-value">00:00</div>
        </div>
      </div>
      
      <div class="analytics-charts">
        <div class="chart-container">
          <h3>Slide Engagement</h3>
          <div class="chart-placeholder">Chart data loading...</div>
        </div>
        <div class="chart-container">
          <h3>Quiz Performance</h3>
          <div class="chart-placeholder">Chart data loading...</div>
        </div>
      </div>
      
      <div class="user-data-table">
        <h3>User Activity</h3>
        <div class="table-container">
          <p>No user data available yet.</p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Modals/Dialogs (shared between views) -->
  <div class="dialog hidden" id="addSlideModal">
    <div class="dialog-content">
      <h2>Add New Slide</h2>
      <div class="form-group">
        <label for="slideTitle" class="form-label">Slide Title:</label>
        <input type="text" id="slideTitle" class="form-control" placeholder="Enter slide title">
      </div>
      <div class="form-group">
        <label for="slideBackground" class="form-label">Background Color:</label>
        <input type="color" id="slideBackground" value="#FFFFFF">
      </div>
      <div class="form-group">
        <label for="slideMedia" class="form-label">Background Media:</label>
        <select id="slideMedia" class="form-control">
          <option value="">None</option>
          <option value="image">Image</option>
          <option value="video">YouTube Video</option>
          <option value="audio">Audio</option>
        </select>
      </div>
      <div class="form-group hidden" id="slideMediaUrlGroup">
        <label for="slideMediaUrl" class="form-label">Media URL:</label>
        <input type="text" id="slideMediaUrl" class="form-control" placeholder="Enter YouTube Video URL">
      </div>
      <div class="form-group hidden" id="slideMediaUploadGroup">
        <label for="slideMediaUpload" class="form-label">Upload File:</label>
        <input type="file" id="slideMediaUpload" class="form-control">
        <small id="uploadHelpText" class="form-text text-muted"></small> 
      </div>
      <div id="addSlideStatus" class="status-message"></div>
      <div class="dialog-actions">
        <button class="btn btn-secondary" id="cancelAddSlideBtn">Cancel</button>
        <button class="btn" id="confirmAddSlideBtn">Add Slide</button>
      </div>
    </div>
  </div>
  
  <div class="dialog hidden" id="addMediaModal">
    <div class="dialog-content">
      <h2>Add Media Element</h2>
      <div class="form-group">
        <label for="mediaType" class="form-label">Media Type:</label>
        <select id="mediaType" class="form-control">
          <option value="youtube">YouTube Video</option>
          <option value="audio">Audio</option>
        </select>
      </div>
      <div class="form-group" id="mediaUrlGroup">
        <label for="mediaUrl" class="form-label">Media URL:</label>
        <input type="text" id="mediaUrl" class="form-control" placeholder="Enter YouTube URL">
      </div>
      <div class="form-group hidden" id="mediaUploadGroup">
        <label for="mediaUpload" class="form-label">Upload Audio File:</label>
        <input type="file" id="mediaUpload" class="form-control" accept="audio/*">
        <small class="form-text text-muted">Upload an audio file (e.g., MP3, WAV).</small>
      </div>
      <div id="addMediaStatus" class="status-message"></div>
      <div class="dialog-actions">
        <button class="btn btn-secondary" id="cancelAddMediaBtn">Cancel</button>
        <button class="btn" id="confirmAddMediaBtn">Add Media</button>
      </div>
    </div>
  </div>
  
  <!-- Include helper JavaScript files -->
  <?!= include('UtilsClient'); ?>
  <?!= include('ConfigClient'); ?>
  <?!= include('canvas-editor'); ?>
  <?!= include('element-factory'); ?>
  <?!= include('property-panel'); ?>
  <?!= include('viewer-app'); ?>
  
  <script>
    // Global variables
    let activeView = 'viewer'; // Default view
    let editorInitialized = false;
    let viewerInitialized = false;
    
    document.addEventListener('DOMContentLoaded', () => {
      console.log("CombinedView DOMContentLoaded");
      
      // Initialize view tabs
      setupViewTabs();
      
      // Parse project data
      const projectDataElement = document.getElementById('projectData');
      if (!projectDataElement) {
        console.error("Project data element not found!");
        showAlert("Error: Could not find project data container.", "error", "alertContainer", false);
        return;
      }
      
      const projectJson = projectDataElement.dataset.project;
      if (!projectJson) {
        console.error("Project JSON data is missing!");
        showAlert("Error: Project data missing.", "error", "alertContainer", false);
        return;
      }
      
      let projectData;
      try {
        projectData = JSON.parse(projectJson);
        console.log("Parsed project data successfully");
        
        // Initialize the viewer immediately (default view)
        initializeViewer(projectData);
        
        // Set up event listeners for global buttons
        document.getElementById('backToProjectsButton').addEventListener('click', () => {
          window.location.href = window.location.pathname; // Go back to project selector
        });
        
        // Set up save button if present
        const saveButton = document.getElementById('saveButton');
        if (saveButton) {
          saveButton.addEventListener('click', saveProject);
        }
        
      } catch (e) {
        console.error("Failed to parse project JSON:", e);
        showAlert(`Error: Could not parse project data. ${e.message}`, "error", "alertContainer", false);
      }
    });
    
    function setupViewTabs() {
      const viewerTab = document.getElementById('viewerTab');
      const editorTab = document.getElementById('editorTab');
      const analyticsTab = document.getElementById('analyticsTab');
      
      if (viewerTab) {
        viewerTab.addEventListener('click', () => switchView('viewer'));
      }
      
      if (editorTab) {
        editorTab.addEventListener('click', () => switchView('editor'));
      }
      
      if (analyticsTab) {
        analyticsTab.addEventListener('click', () => switchView('analytics'));
      }
    }
    
    function switchView(viewName) {
      // Update active tab
      document.querySelectorAll('.view-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      document.getElementById(`${viewName}Tab`).classList.add('active');
      
      // Hide all containers
      document.getElementById('viewerContainer').classList.add('hidden');
      
      const editorContainer = document.getElementById('editorContainer');
      if (editorContainer) {
        editorContainer.classList.add('hidden');
      }
      
      const analyticsContainer = document.getElementById('analyticsContainer');
      if (analyticsContainer) {
        analyticsContainer.classList.add('hidden');
      }
      
      // Show selected container
      document.getElementById(`${viewName}Container`).classList.remove('hidden');
      
      // Initialize the view if needed
      if (viewName === 'editor' && !editorInitialized) {
        initializeEditor();
      } else if (viewName === 'analytics' && !analyticsInitialized) {
        initializeAnalytics();
      }
      
      activeView = viewName;
      
      // Update title based on active view
      updateTitle(viewName);
    }
    
    function updateTitle(viewName) {
      const projectTitle = '<?= project.title ?>';
      const appTitle = document.getElementById('appTitle');
      
      switch(viewName) {
        case 'editor':
          appTitle.textContent = `Edit: ${projectTitle}`;
          break;
        case 'analytics':
          appTitle.textContent = `Analytics: ${projectTitle}`;
          break;
        default:
          appTitle.textContent = projectTitle;
      }
    }
    
    function initializeViewer(projectData) {
      console.log("Initializing viewer");
      
      // This would call the viewer initialization from viewer-app.js
      if (typeof initViewer === 'function') {
        initViewer(projectData);
        viewerInitialized = true;
      } else {
        console.warn("initViewer function not found. Viewer functionality may be limited.");
        // Display a placeholder message in the viewer
        document.querySelector('.loading-placeholder').textContent = 
          "Viewer implementation in progress. Basic slide navigation available.";
          
        // Setup basic slide navigation with placeholders
        setupBasicViewer(projectData);
      }
    }
    
    function setupBasicViewer(projectData) {
      // A very basic placeholder implementation until the full viewer is developed
      const prevBtn = document.getElementById('prevSlideBtn');
      const nextBtn = document.getElementById('nextSlideBtn');
      const slideCounter = document.getElementById('slideCounter');
      const slideCanvas = document.getElementById('slideCanvas');
      
      let currentSlideIndex = 0;
      const slides = projectData.slides || [];
      
      // Update slide counter
      function updateSlideCounter() {
        slideCounter.textContent = `Slide ${currentSlideIndex + 1} of ${slides.length}`;
      }
      
      // Display a slide
      function displaySlide(index) {
        if (slides.length === 0) {
          slideCanvas.innerHTML = '<div class="empty-state">No slides available</div>';
          return;
        }
        
        const slide = slides[index];
        slideCanvas.innerHTML = `
          <div class="basic-slide" style="background-color: ${slide.backgroundColor || '#ffffff'}">
            <h2>${slide.title || 'Untitled Slide'}</h2>
            ${slide.fileUrl ? `<div class="media-placeholder">Media: ${slide.fileType}</div>` : ''}
            <div class="elements-placeholder">Elements will be displayed here in the completed viewer</div>
          </div>
        `;
        
        updateSlideCounter();
      }
      
      // Navigation handlers
      prevBtn.addEventListener('click', () => {
        if (currentSlideIndex > 0) {
          currentSlideIndex--;
          displaySlide(currentSlideIndex);
        }
      });
      
      nextBtn.addEventListener('click', () => {
        if (currentSlideIndex < slides.length - 1) {
          currentSlideIndex++;
          displaySlide(currentSlideIndex);
        }
      });
      
      // Initial display
      if (slides.length > 0) {
        displaySlide(currentSlideIndex);
      } else {
        slideCanvas.innerHTML = '<div class="empty-state">No slides available</div>';
        slideCounter.textContent = 'No slides';
      }
      
      viewerInitialized = true;
    }
    
    function initializeEditor() {
      console.log("Initializing editor");
      
      // Get project data again
      const projectDataElement = document.getElementById('projectData');
      const projectJson = projectDataElement.dataset.project;
      const projectData = JSON.parse(projectJson);
      
      // This would call the editor initialization from canvas-editor.js
      if (typeof initEditor === 'function') {
        initEditor(projectData);
        setupEditorEventListeners();
        editorInitialized = true;
      } else {
        console.error("initEditor function not found. Editor cannot be initialized.");
        showAlert("Editor initialization failed: Required functions missing.", "error");
      }
    }
    
    function setupEditorEventListeners() {
      // Add slide buttons
      document.getElementById('btnAddSlide').addEventListener('click', showAddSlideModal);
      document.getElementById('addSlideButton').addEventListener('click', showAddSlideModal);
      document.getElementById('cancelAddSlideBtn').addEventListener('click', hideAddSlideModal);
      document.getElementById('confirmAddSlideBtn').addEventListener('click', addNewSlide);
      
      // Media type change in add slide modal
      document.getElementById('slideMedia').addEventListener('change', function() {
        const mediaType = this.value;
        const urlGroup = document.getElementById('slideMediaUrlGroup');
        const uploadGroup = document.getElementById('slideMediaUploadGroup');
        urlGroup.style.display = (mediaType === 'video') ? 'block' : 'none';
        uploadGroup.style.display = (mediaType === 'image' || mediaType === 'audio') ? 'block' : 'none';
      });
      
      // Add media modal buttons
      document.getElementById('btnMedia').addEventListener('click', showAddMediaModal);
      document.getElementById('cancelAddMediaBtn').addEventListener('click', hideAddMediaModal);
      document.getElementById('confirmAddMediaBtn').addEventListener('click', addNewMedia);
      
      // Media type change in add media modal
      document.getElementById('mediaType').addEventListener('change', function() {
        const mediaType = this.value;
        const urlGroup = document.getElementById('mediaUrlGroup');
        const uploadGroup = document.getElementById('mediaUploadGroup');
        urlGroup.style.display = (mediaType === 'youtube') ? 'block' : 'none';
        uploadGroup.style.display = (mediaType === 'audio') ? 'block' : 'none';
      });
      
      // Shape creation buttons
      document.getElementById('btnRectangle').addEventListener('click', () => createShape('rectangle'));
      document.getElementById('btnCircle').addEventListener('click', () => createShape('circle'));
      document.getElementById('btnText').addEventListener('click', () => createShape('text'));
      document.getElementById('btnHotspot').addEventListener('click', () => createShape('hotspot'));
      document.getElementById('btnArrow').addEventListener('click', () => createShape('arrow'));
      
      // Editing operations buttons
      document.getElementById('btnDelete').addEventListener('click', deleteSelectedObjects);
      document.getElementById('btnCopy').addEventListener('click', copySelectedObjects);
      document.getElementById('btnPaste').addEventListener('click', pasteObjects);
      document.getElementById('btnBringForward').addEventListener('click', bringForward);
      document.getElementById('btnSendBackward').addEventListener('click', sendBackward);
      
      // Upload image button
      document.getElementById('btnUploadImage').addEventListener('click', uploadImage);
    }
    
    function initializeAnalytics() {
      console.log("Initializing analytics");
      
      // This would call the analytics initialization
      // Since this is not yet implemented, we'll just mark it as initialized
      analyticsInitialized = true;
      
      // Load analytics data from server
      loadAnalyticsData();
    }
    
    function loadAnalyticsData() {
      // Example implementation - replace with actual API call
      const projectId = '<?= project.projectId ?>';
      
      // Show loading state
      document.querySelectorAll('.chart-placeholder').forEach(placeholder => {
        placeholder.textContent = 'Loading data...';
      });
      
      // Call the API to get analytics data
      api.getAnalyticsData(projectId)
        .then(data => {
          console.log('Analytics data loaded:', data);
          // Update the UI with the data
          updateAnalyticsUI(data);
        })
        .catch(error => {
          console.error('Error loading analytics data:', error);
          document.querySelectorAll('.chart-placeholder').forEach(placeholder => {
            placeholder.textContent = 'Failed to load data. Try again later.';
          });
        });
    }
    
    function updateAnalyticsUI(data) {
      // This would update the analytics UI with the loaded data
      // For now, just a placeholder implementation
      document.querySelector('.metric-value:nth-child(1)').textContent = data?.totalViews || '0';
      document.querySelector('.metric-value:nth-child(2)').textContent = `${data?.completionRate || '0'}%`;
      document.querySelector('.metric-value:nth-child(3)').textContent = data?.avgScore ? `${data.avgScore}%` : 'N/A';
      document.querySelector('.metric-value:nth-child(4)').textContent = formatTime(data?.avgTime || 0);
      
      // Update charts (would use a charting library in the full implementation)
      document.querySelectorAll('.chart-placeholder').forEach(placeholder => {
        placeholder.textContent = 'Chart would be rendered here with the actual data.';
      });
      
      // Update user table
      const tableContainer = document.querySelector('.table-container');
      if (data?.users?.length > 0) {
        tableContainer.innerHTML = `
          <table class="data-table">
            <thead>
              <tr>
                <th>User</th>
                <th>Last Activity</th>
                <th>Progress</th>
                <th>Score</th>
              </tr>
            </thead>
            <tbody>
              ${data.users.map(user => `
                <tr>
                  <td>${user.name || user.email}</td>
                  <td>${formatDate(user.lastActivityTime)}</td>
                  <td>${user.percentComplete}%</td>
                  <td>${user.quizScore}%</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } else {
        tableContainer.innerHTML = '<p>No user data available yet.</p>';
      }
    }
    
    // Helper function to format time
    function formatTime(milliseconds) {
      const totalSeconds = Math.floor(milliseconds / 1000);
      const minutes = Math.floor(totalSeconds / 60);
      const seconds = totalSeconds % 60;
      return `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }
    
    // Helper function to format date
    function formatDate(timestamp) {
      if (!timestamp) return 'N/A';
      const date = new Date(timestamp);
      return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
    }
    
    // Modal functions
    function showAddSlideModal() {
      if (!window.editorState || !editorState.project || !editorState.project.slides) {
        console.error("Cannot show add slide modal: editor state not ready.");
        showAlert("Editor not fully loaded, please wait.", "warning");
        return;
      }
      document.getElementById('addSlideModal').classList.remove('hidden');
      document.getElementById('slideTitle').value = 'Slide ' + (editorState.project.slides.length + 1);
      document.getElementById('slideBackground').value = '#FFFFFF';
      document.getElementById('slideMedia').value = '';
      document.getElementById('slideMediaUrl').value = '';
      document.getElementById('slideMediaUpload').value = '';
      document.getElementById('slideMediaUrlGroup').style.display = 'none';
      document.getElementById('slideMediaUploadGroup').style.display = 'none';
    }
    
    function hideAddSlideModal() {
      document.getElementById('addSlideModal').classList.add('hidden');
    }
    
    function showAddMediaModal() {
      document.getElementById('addMediaModal').classList.remove('hidden');
      document.getElementById('mediaType').value = 'youtube';
      document.getElementById('mediaUrl').value = '';
      document.getElementById('mediaUpload').value = '';
      document.getElementById('mediaUrlGroup').style.display = 'block';
      document.getElementById('mediaUploadGroup').style.display = 'none';
    }
    
    function hideAddMediaModal() {
      document.getElementById('addMediaModal').classList.add('hidden');
    }
    
    // Save project function
    async function saveProject() {
      if (typeof serializeProject !== 'function') {
        console.error("saveProject error: serializeProject function not found.");
        showAlert("Error: Cannot serialize project state.", "error");
        return;
      }
      
      const projectToSave = serializeProject();
      if (!projectToSave || !projectToSave.projectId) {
        console.error("saveProject error: Invalid project data from serializeProject.");
        showAlert("Error: Invalid project data.", "error");
        return;
      }
      
      showAlert('Saving project...', 'info');
      
      const updatesToSend = {
        slides: projectToSave.slides,
        elements: projectToSave.elements
      };
      
      try {
        const result = await api.updateProject(projectToSave.projectId, updatesToSend);
        console.log("Save successful:", result);
        showAlert('Project saved successfully!', 'success');
      } catch (error) {
        console.error("Save project error:", error);
        showAlert('Error saving project: ' + error.message, 'error');
      }
    }
    
    // Add new slide function - placeholder that would call the actual implementation
    function addNewSlide() {
      // This would be implemented by the actual editor functions
      console.log("addNewSlide called");
    }
    
    // Add media element function - placeholder that would call the actual implementation
    function addNewMedia() {
      // This would be implemented by the actual editor functions
      console.log("addNewMedia called");
    }
    
    // Upload image function - placeholder that would call the actual implementation
    function uploadImage() {
      // This would be implemented by the actual editor functions
      console.log("uploadImage called");
    }
    
    // Set up other required functions from the editor
    // These are placeholders that would call the actual implementations
    function createShape(type) { console.log("createShape called with type:", type); }
    function deleteSelectedObjects() { console.log("deleteSelectedObjects called"); }
    function copySelectedObjects() { console.log("copySelectedObjects called"); }
    function pasteObjects() { console.log("pasteObjects called"); }
    function bringForward() { console.log("bringForward called"); }
    function sendBackward() { console.log("sendBackward called"); }
  </script>
</body>
</html>