<!-- Common.html - Shared HTML components for the Interactive Training Projects Web App -->

<!-- Common CSS -->
<style>
    /* Variables */
    :root {
      --primary-color: #4285F4;
      --secondary-color: #34A853;
      --accent-color: #EA4335;
      --background-color: #F5F5F5;
      --text-color: #333333;
      --light-text-color: #757575;
      --border-color: #DDDDDD;
      --success-color: #4CAF50;
      --error-color: #F44336;
      --warning-color: #FFC107;
    }
    
    /* Reset */
    *, *::before, *::after {
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Roboto', Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: var(--background-color);
      color: var(--text-color);
      line-height: 1.6;
    }
    
    /* Header */
    .header {
      background-color: var(--primary-color);
      color: white;
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .header-title {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 500;
    }
    
    .header-actions {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    /* Footer */
    .footer {
      background-color: #f1f1f1;
      padding: 1rem;
      text-align: center;
      color: var(--light-text-color);
      font-size: 0.9rem;
      margin-top: 2rem;
    }
    
    /* Buttons */
    .btn {
      display: inline-block;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      background-color: var(--primary-color);
      color: white;
      text-decoration: none;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      transition: background-color 0.2s;
    }
    
    .btn:hover {
      background-color: #3367D6;
    }
    
    .btn-secondary {
      background-color: white;
      color: var(--primary-color);
      border: 1px solid var(--primary-color);
    }
    
    .btn-secondary:hover {
      background-color: #f5f5f5;
    }
    
    .btn-accent {
      background-color: var(--accent-color);
    }
    
    .btn-accent:hover {
      background-color: #C62828;
    }
    
    .btn-success {
      background-color: var(--success-color);
    }
    
    .btn-success:hover {
      background-color: #388E3C;
    }
    
    /* Cards */
    .card {
      background-color: white;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    
    .card-title {
      margin-top: 0;
      margin-bottom: 1rem;
      font-size: 1.2rem;
      font-weight: 500;
    }
    
    /* Forms */
    .form-group {
      margin-bottom: 1rem;
    }
    
    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }
    
    .form-control {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 1rem;
    }
    
    .form-control:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.2);
    }
    
    /* Alerts */
    .alert {
      padding: 1rem;
      border-radius: 4px;
      margin-bottom: 1rem;
    }
    
    .alert-success {
      background-color: #E8F5E9;
      color: #2E7D32;
      border: 1px solid #C8E6C9;
    }
    
    .alert-error {
      background-color: #FFEBEE;
      color: #C62828;
      border: 1px solid #FFCDD2;
    }
    
    .alert-warning {
      background-color: #FFF8E1;
      color: #F57F17;
      border: 1px solid #FFECB3;
    }
    
    .alert-info {
      background-color: #E3F2FD;
      color: #1565C0;
      border: 1px solid #BBDEFB;
    }
    
    /* Utilities */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1.5rem;
    }
    
    .text-center {
      text-align: center;
    }
    
    .text-right {
      text-align: right;
    }
    
    .mb-0 {
      margin-bottom: 0;
    }
    
    .mb-1 {
      margin-bottom: 0.5rem;
    }
    
    .mb-2 {
      margin-bottom: 1rem;
    }
    
    .mb-3 {
      margin-bottom: 1.5rem;
    }
    
    .mt-0 {
      margin-top: 0;
    }
    
    .mt-1 {
      margin-top: 0.5rem;
    }
    
    .mt-2 {
      margin-top: 1rem;
    }
    
    .mt-3 {
      margin-top: 1.5rem;
    }
    
    .d-flex {
      display: flex;
    }
    
    .justify-between {
      justify-content: space-between;
    }
    
    .align-center {
      align-items: center;
    }
    
    .gap-1 {
      gap: 0.5rem;
    }
    
    .gap-2 {
      gap: 1rem;
    }
    
    .hidden {
      display: none;
    }
      /* Canvas Editor Styles */
    .canvas-container {
        border: 1px solid var(--border-color);
        background-color: #f8f8f8;
        margin: 0 auto;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }
    
    .editor-container {
        display: flex;
        height: calc(100vh - 120px);
        min-height: 500px;
    }
    
    .slides-panel {
        width: 200px;
        background-color: white;
        border-right: 1px solid var(--border-color);
        overflow-y: auto;
        padding: 1rem;
    }
    
    .properties-panel {
        width: 280px;
        background-color: white;
        border-left: 1px solid var(--border-color);
        overflow-y: auto;
        padding: 1rem;
    }
    
    .canvas-panel {
        flex: 1;
        overflow: hidden;
        position: relative;
        background-color: #e9e9e9;
    }
    
    .canvas-scaler {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        transform-origin: center center;
    }
    
    .toolbar {
        background-color: white;
        border-bottom: 1px solid var(--border-color);
        padding: 0.5rem;
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    
    .timeline-panel {
        height: 150px;
        background-color: white;
        border-top: 1px solid var(--border-color);
        overflow-x: auto;
        padding: 0.5rem;
    }
    
    .slide-thumbnail {
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 0.5rem;
        margin-bottom: 0.5rem;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .slide-thumbnail.active {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.2);
    }
    
    .slide-thumbnail-img {
        width: 100%;
        height: 100px;
        background-color: #f5f5f5;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 0.5rem;
    }
    
    .slide-thumbnail-title {
        font-size: 0.8rem;
        text-align: center;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .property-group {
        margin-bottom: 1rem;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        overflow: hidden;
    }
    
    .property-group-header {
        background-color: #f5f5f5;
        padding: 0.5rem;
        font-weight: 500;
        border-bottom: 1px solid var(--border-color);
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .property-group-content {
        padding: 0.5rem;
    }
    
    .property-row {
        display: flex;
        margin-bottom: 0.5rem;
        align-items: center;
    }
    
    .property-label {
        flex: 2;
        font-size: 0.9rem;
    }
    
    .property-field {
        flex: 3;
    }
    
    .color-preview {
        width: 20px;
        height: 20px;
        border: 1px solid var(--border-color);
        border-radius: 3px;
        display: inline-block;
        vertical-align: middle;
        margin-right: 0.5rem;
    }
    
    .timeline-track {
        height: 30px;
        margin-bottom: 5px;
        position: relative;
        border: 1px solid var(--border-color);
        border-radius: 3px;
    }
    
    .timeline-keyframe {
        position: absolute;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background-color: var(--primary-color);
        top: 50%;
        transform: translateY(-50%);
        cursor: pointer;
    }
    
    .timeline-controls {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
    }
    
    .timeline-time {
        font-size: 0.9rem;
        min-width: 60px;
    }
  </style>
  
  <!-- Common JavaScript -->
  <script>
    /**
     * API client for making requests to the server
     */
    class ApiClient {
      constructor() {
        // Base URL is determined automatically for WebApps
        this.baseUrl = '';
      }
      
      /**
       * Makes an API request to the server
       * @param {string} action - The action to perform
       * @param {Object} data - The data to send with the request
       * @returns {Promise<Object>} - The response data
       */
      async request(action, data = {}) {
        try {
          console.log(`Making API request: ${action}`, data);
          
          // Create the request payload
          const payload = {
            action: action,
            ...data
          };
          
          // Make the request
          const response = await new Promise((resolve, reject) => {
            google.script.run
              .withSuccessHandler(result => {
                console.log(`API response for ${action}:`, result);
                resolve(result);
              })
              .withFailureHandler(error => {
                console.error(`API error for ${action}:`, error);
                reject(error);
              })
              .processApiRequest(payload);
          });
          
          // Check for null response
          if (response === null) {
            console.error("Received null response from server");
            throw new Error("Received null response from server");
          }
          
          // Unwrap the response if possible
          if (typeof response === 'object' && 'success' in response) {
            if (response.success) {
              return response.data || {};
            } else {
              throw new Error(response.error || "Unknown error");
            }
          }
          
          // Return the raw response if it doesn't match the expected format
          return response;
        } catch (error) {
          console.error(`API error in ${action}:`, error);
          throw error;
        }
      }
      
      // Helper methods for common requests
      async listProjects() {
        try {
          const result = await this.request('listProjects');
          console.log("Projects result:", result);
          return result.projects || [];
        } catch (error) {
          console.error("Error listing projects:", error);
          return [];
        }
      }
      
      // Helper methods for common requests
      async getProject(projectId) {
        return this.request('project.get', { projectId });
      }
      
      async listProjects() {
        return this.request('project.list');
      }
      
      async createProject(name) {
        return this.request('project.create', { name });
      }
      
      async updateProject(projectId, updates) {
        return this.request('project.update', { projectId, updates });
      }
      
      async deleteProject(projectId, deleteDriveFiles = false) {
        return this.request('project.delete', { projectId, deleteDriveFiles });
      }
      
      async addSlide(projectId, slide) {
        return this.request('slide.add', { projectId, slide });
      }
      
      async updateSlide(projectId, slideId, updates) {
        return this.request('slide.update', { projectId, slideId, updates });
      }
      
      async deleteSlide(projectId, slideId) {
        return this.request('slide.delete', { projectId, slideId });
      }
      
      async addElement(projectId, slideId, element) {
        return this.request('element.add', { projectId, slideId, element });
      }
      
      async updateElement(projectId, elementId, updates) {
        return this.request('element.update', { projectId, elementId, updates });
      }
      
      async deleteElement(projectId, elementId) {
        return this.request('element.delete', { projectId, elementId });
      }
      
      async processMediaUrl(projectId, url, options = {}) {
        return this.request('media.process', { projectId, url, options });
      }
      
      async saveUserProgress(projectId, progress) {
        return this.request('tracking.saveProgress', { projectId, progress });
      }
      
      async getUserProgress(projectId) {
        return this.request('tracking.getProgress', { projectId });
      }
      
      async getAnalyticsData(projectId) {
        return this.request('analytics.getProjectData', { projectId });
      }
      
      async login(projectId) {
        return this.request('auth.login', { projectId });
      }
      
      async logout() {
        return this.request('auth.logout');
      }
      
      async getAuthStatus(projectId) {
        return this.request('auth.getStatus', { projectId });
      }
    }
    
    // Create global API client instance
    const api = new ApiClient();
    
    // Utility functions
    
    // Show an alert message
    function showAlert(message, type = 'info', container = 'alertContainer', autoHide = true) {
      const alertContainer = document.getElementById(container);
      if (!alertContainer) return;
      
      const alertElement = document.createElement('div');
      alertElement.className = `alert alert-${type}`;
      alertElement.textContent = message;
      
      alertContainer.innerHTML = '';
      alertContainer.appendChild(alertElement);
      alertContainer.style.display = 'block';
      
      if (autoHide) {
        setTimeout(() => {
          alertContainer.style.display = 'none';
        }, 5000);
      }
    }
    
    // Format a date
    function formatDate(timestamp) {
      if (!timestamp) return 'N/A';
      
      const date = new Date(timestamp);
      return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
    }
    
    // Sanitize HTML to prevent XSS
    function sanitizeHtml(html) {
      const temp = document.createElement('div');
      temp.textContent = html;
      return temp.innerHTML;
    }
    
    // Get URL parameters
    function getUrlParams() {
      const params = {};
      const queryString = window.location.search.substring(1);
      const pairs = queryString.split('&');
      
      for (const pair of pairs) {
        const [key, value] = pair.split('=');
        params[decodeURIComponent(key)] = decodeURIComponent(value || '');
      }
      
      return params;
    }
    
    // Copy text to clipboard
    function copyToClipboard(text) {
      const input = document.createElement('textarea');
      input.value = text;
      document.body.appendChild(input);
      input.select();
      document.execCommand('copy');
      document.body.removeChild(input);
    }
  </script>
  
  <!-- Common Header Component -->
  <div id="commonHeader" class="header">
    <h1 class="header-title">Interactive Training Projects</h1>
    <div class="header-actions">
      <span id="userEmail"></span>
      <button class="btn btn-secondary" id="backButton" onclick="goBack()" style="display: none;">Back</button>
    </div>
  </div>
  
  <!-- Common Footer Component -->
  <div id="commonFooter" class="footer">
    <p>&copy; <?= new Date().getFullYear() ?> Interactive Training Projects</p>
  </div>
  
  <script>
    // Set user email in header
    document.getElementById('userEmail').textContent = '<?= user.email ?>';
    
    // Back button functionality
    function goBack() {
      window.history.back();
    }
    
    // Show back button if not on the main page
    if (window.location.search) {
      document.getElementById('backButton').style.display = 'inline-block';
    }

    // Add to the end of Common.html
    function checkApiConnection() {
    console.log('Checking API connection...');
    
    google.script.run
        .withSuccessHandler(function(result) {
        console.log('API connection test result:', result);
        })
        .withFailureHandler(function(error) {
        console.error('API connection test failed:', error);
        })
        .processApiRequest({action: 'auth.getStatus'});
    }

    // Make it available globally
    window.checkApiConnection = checkApiConnection;
  </script>