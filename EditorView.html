<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Edit: <?= projectTitle ?> - Interactive Training</title>
  
  <?!= include('Common'); ?>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
  
  <script>
    console.log("EditorView.html loading at:", new Date().toISOString());
    // Log URL parameters
    console.log("URL:", window.location.href);
    console.log("Project ID from URL:", new URLSearchParams(window.location.search).get('project'));
    
    // Add global error handler
    window.onerror = function(message, source, lineno, colno, error) {
      console.error("Global error:", message, "at", source, "line", lineno);
      // Display visible error on page
      document.body.innerHTML = `
        <div style="color:red; padding:20px; font-family:sans-serif">
          <h2>Error Loading Editor</h2>
          <p>${message}</p>
          <p>Source: ${source}</p>
          <p>Line: ${lineno} Column: ${colno}</p>
        </div>
      `;
      return false; // Allow default error handling too
    };
  </script>
  <style>
    /* Editor-specific styles from original file */
    body {
      overflow: hidden; /* Prevent scrolling of the main body */
      margin: 0; /* Remove default body margin */
      display: flex;
      flex-direction: column;
      height: 100vh; /* Full viewport height */
    }
    
    .editor-header {
      padding: 0.5rem 1rem;
      background-color: var(--primary-color);
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0; /* Prevent header from shrinking */
    }
    
    .editor-title {
      margin: 0;
      font-size: 1.2rem;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .editor-actions {
      display: flex;
      gap: 0.5rem; /* Slightly reduced gap */
      align-items: center;
      flex-shrink: 0;
    }
    
    .editor-actions .btn {
      margin: 0;
    }

    .toolbar {
        padding: 0.5rem;
        background-color: #f8f9fa; /* Lighter background */
        border-bottom: 1px solid var(--border-color);
        display: flex;
        flex-wrap: wrap; /* Allow wrapping on smaller screens */
        gap: 0.5rem;
        flex-shrink: 0;
    }

    .toolbar .btn-secondary { /* Style toolbar buttons */
        padding: 0.25rem 0.5rem; /* Smaller padding */
        font-size: 0.85rem;
    }

    .toolbar-separator {
        border-right: 1px solid #ccc; 
        margin: 0 0.5rem; 
        height: 24px;
        align-self: center;
    }
    
    .editor-container {
        display: flex;
        flex-grow: 1; /* Allow main container to fill space */
        overflow: hidden; /* Prevent overflow */
        background-color: var(--background-color); /* Match body background */
    }
    
    /* Slides Panel */
    .slides-panel {
        width: 200px;
        background-color: white;
        border-right: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        overflow: hidden;
         flex-shrink: 0;
    }
    .slides-header {
        padding: 0.75rem;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
         flex-shrink: 0;
    }
     .slides-header h3 {
         margin: 0;
         font-size: 1rem;
     }
    #slides-list {
        overflow-y: auto;
        flex-grow: 1;
        padding: 0.5rem;
    }
     /* Style for individual slide thumbnails (can be added in canvas-editor.js) */
    .slide-thumbnail {
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 0.5rem;
        margin-bottom: 0.5rem;
        cursor: pointer;
        transition: all 0.2s;
        background-color: #fff;
    }
    .slide-thumbnail.active {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.2);
    }
     .slide-thumbnail-img {
        height: 80px; /* Adjust size */
        background-color: #f5f5f5;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 0.5rem;
        border: 1px dashed #ccc;
    }
     .slide-thumbnail-title {
        font-size: 0.8rem;
        text-align: center;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }


    /* Canvas Panel */
    .canvas-panel {
        flex-grow: 1; /* Take remaining space */
        overflow: auto; /* Allow scrolling if canvas is larger */
        position: relative; /* Needed for scaler positioning */
        background-color: #e9e9e9; /* Background behind canvas */
        display: flex; /* Center canvas */
        justify-content: center;
        align-items: center;
        padding: 1rem; /* Add padding around canvas */
    }
    
    .canvas-scaler { /* Centers the canvas */
        /* Removed absolute positioning - handled by flexbox now */
        transform-origin: center center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15); /* Add shadow to canvas */
        background-color: white; /* Ensure canvas itself has white background if needed */
    }
    
    /* Properties Panel */
    .properties-panel {
        width: 280px;
        background-color: white;
        border-left: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        overflow: hidden;
         flex-shrink: 0;
    }
     .properties-panel h3 {
         margin: 0;
         font-size: 1rem;
         padding: 0.75rem;
         border-bottom: 1px solid var(--border-color);
          flex-shrink: 0;
     }
     #properties-container, #no-selection-message {
         overflow-y: auto;
         flex-grow: 1;
         padding: 1rem;
     }
      #no-selection-message p {
          color: var(--light-text-color);
          text-align: center;
          margin-top: 2rem;
      }
     /* Property Group Styles (from Common.html, ensure they are loaded) */
     .property-group { margin-bottom: 1rem; border: 1px solid var(--border-color); border-radius: 4px; overflow: hidden; }
     .property-group-header { background-color: #f5f5f5; padding: 0.5rem 0.75rem; font-weight: 500; border-bottom: 1px solid var(--border-color); cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem;}
     .property-group-header .toggle-icon { font-size: 0.8rem; }
     .property-group-content { padding: 0.75rem; font-size: 0.9rem; }
     .property-row { display: flex; margin-bottom: 0.75rem; align-items: center; }
     .property-label { flex: 2; padding-right: 0.5rem; }
     .property-field { flex: 3; }
     .property-field input[type=number], .property-field input[type=text], .property-field select, .property-field textarea { width: 100%; font-size: 0.85rem; padding: 0.3rem 0.5rem;}
     .property-field textarea { resize: vertical; min-height: 60px; }
     .property-field input[type=color] { width: 30px; height: 30px; padding: 0; border: 1px solid #ccc; cursor: pointer; vertical-align: middle; }
     .property-field input[type=range] { width: calc(100% - 40px); vertical-align: middle; margin-right: 5px; } /* Adjust width for value display */
     .property-field input[type=checkbox] { margin-right: 5px; vertical-align: middle;}
     .property-field .color-preview { display: inline-block; width: 20px; height: 20px; border: 1px solid #ccc; border-radius: 3px; vertical-align: middle; margin-left: 5px; }
     .property-field span { vertical-align: middle; font-size: 0.85rem;} /* For range value display */
     .property-subgroup { margin-left: 1rem; margin-top: 0.5rem; padding-left: 0.5rem; border-left: 2px solid #eee; }


    /* Timeline Panel */
    .timeline-panel {
        height: 150px; /* Adjust height as needed */
        background-color: white;
        border-top: 1px solid var(--border-color);
        overflow: hidden; /* Let inner elements scroll */
        padding: 0.5rem;
        display: flex;
        flex-direction: column;
        flex-shrink: 0; /* Prevent shrinking */
    }
    .timeline-controls {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--border-color);
         flex-shrink: 0;
    }
    .timeline-time {
        font-size: 0.85rem;
        min-width: 70px; /* Wider for MM:SS.ms */
        text-align: center;
        color: var(--light-text-color);
    }
     #timeline-ruler {
         flex-grow: 1; 
         height: 20px; 
         background: #eee; 
         position: relative; 
         cursor: pointer;
         border-radius: 3px;
     }
      #timeline-playhead { 
          position: absolute; 
          top: 0; left: 0; 
          width: 2px; 
          height: 100%; 
          background: var(--accent-color); 
          pointer-events: none; /* Don't interfere with clicks on ruler */
      }
    #timeline-tracks {
        overflow-y: auto; /* Allow vertical scrolling for tracks */
        flex-grow: 1;
    }
     /* Timeline Track Styles (can be added in canvas-editor.js) */
     .timeline-track { display: flex; height: 30px; margin-bottom: 5px; align-items: center; }
     .timeline-track-label { width: 100px; font-size: 0.8rem; padding-right: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--light-text-color); }
     .timeline-track-content { flex-grow: 1; height: 100%; position: relative; background-color: #f8f8f8; border: 1px solid #eee; border-radius: 3px; }
     .timeline-keyframe { position: absolute; width: 10px; height: 10px; border-radius: 50%; background-color: var(--primary-color); top: 50%; transform: translateY(-50%); cursor: pointer; border: 1px solid white; }
     .timeline-keyframe-start { background-color: var(--secondary-color); } /* Green for start */
     .timeline-keyframe-end { background-color: var(--accent-color); } /* Red for end */


    /* Make color inputs and range inputs look nicer */
    input[type="color"] {
      -webkit-appearance: none;
      appearance: none;
      border: 1px solid #ccc; /* Add border */
      width: 30px;
      height: 30px;
      cursor: pointer;
      border-radius: 4px;
      padding: 0; /* Remove padding */
      background-color: transparent; /* Ensure background doesn't interfere */
    }
    
    input[type="color"]::-webkit-color-swatch-wrapper {
      padding: 0;
    }
    
    input[type="color"]::-webkit-color-swatch {
      border: none;
      border-radius: 3px; /* Slightly smaller radius */
    }
     input[type="color"]::-moz-color-swatch { /* Firefox */
       border: none;
       border-radius: 3px;
     }
    
    input[type="range"] {
      -webkit-appearance: none;
      appearance: none;
      width: 100%; /* Let flexbox handle sizing */
      height: 5px;
      border-radius: 5px;
      background: #d7dcdf;
      outline: none;
      cursor: pointer;
      margin: 0; /* Remove default margin */
    }
    
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 15px;
      height: 15px;
      border-radius: 50%;
      background: var(--primary-color);
      cursor: pointer;
    }
     input[type="range"]::-moz-range-thumb { /* Firefox */
       width: 15px;
       height: 15px;
       border-radius: 50%;
       background: var(--primary-color);
       cursor: pointer;
       border: none;
     }
    
    /* Tooltip styles */
    .tooltip {
      position: relative;
      display: inline-block;
    }
    
    .tooltip .tooltip-text {
      visibility: hidden;
      width: 120px;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 5px;
      position: absolute;
      z-index: 1001; /* Ensure above other elements */
      bottom: 125%; /* Position above the button */
      left: 50%;
      margin-left: -60px; /* Center the tooltip */
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 0.8rem;
      pointer-events: none; /* Don't block clicks on button */
    }
    
    .tooltip:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
    }

    /* Dialog Styles (Basic) */
    .dialog {
        position: fixed;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1050; /* High z-index */
    }
    .dialog-content {
        background-color: white;
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        width: 90%;
        max-width: 500px; /* Max width */
    }
     .dialog-content h2 {
         margin-top: 0;
         margin-bottom: 1.5rem;
         font-size: 1.3rem;
     }
    .dialog-actions {
        display: flex;
        justify-content: flex-end;
        margin-top: 1.5rem;
        gap: 0.5rem;
    }
    .hidden {
        display: none;
    }

  </style>
</head>
<body>
  <!-- Container for alert messages -->
  <div id="alertContainer" style="display: none; position: fixed; top: 10px; right: 10px; z-index: 1000;"></div>

  <!-- === ADD THIS LINE === -->
  <div id="projectData" data-project='<?= JSON.stringify(project) ?>' style="display: none;"></div>
  
  <div class="editor-header">
    <h1 id="editorProjectTitle" class="editor-title">Edit: <?= projectTitle ?></h1> 
    <div class="editor-actions">
      <button id="saveButton" class="btn btn-sm">Save</button> <button id="previewButton" class="btn btn-secondary btn-sm">Preview</button>
      <button id="backToProjectsButton" class="btn btn-secondary btn-sm">Back</button>
    </div>
  </div>
  
  <div class="toolbar" id="editor-toolbar">
    <button class="btn btn-secondary" id="btnAddSlide" title="Add Slide">
      <span class="tooltip">➕ Slide<span class="tooltip-text">Add a new slide</span></span>
    </button>
    <div class="toolbar-separator"></div>
    
    <button class="btn btn-secondary" id="btnRectangle" title="Add Rectangle">
      <span class="tooltip">▭<span class="tooltip-text">Add rectangle shape</span></span>
    </button>
    <button class="btn btn-secondary" id="btnCircle" title="Add Circle">
      <span class="tooltip">○<span class="tooltip-text">Add circle shape</span></span>
    </button>
    <button class="btn btn-secondary" id="btnText" title="Add Text">
      <span class="tooltip">T<span class="tooltip-text">Add text element</span></span>
    </button>
    <button class="btn btn-secondary" id="btnHotspot" title="Add Hotspot">
       <span class="tooltip">🎯<span class="tooltip-text">Add interactive hotspot</span></span>
    </button>
    <button class="btn btn-secondary" id="btnArrow" title="Add Arrow">
       <span class="tooltip">→<span class="tooltip-text">Add arrow shape</span></span>
    </button>
    
    <div class="toolbar-separator"></div>
    
    <button class="btn btn-secondary" id="btnUploadImage" title="Add Image">
      <span class="tooltip">🖼️ Image<span class="tooltip-text">Upload an image</span></span>
    </button>
    <button class="btn btn-secondary" id="btnMedia" title="Add Video/Audio">
       <span class="tooltip">🎬 Media<span class="tooltip-text">Add video or audio</span></span>
    </button>
    
    <div class="toolbar-separator"></div>
    
    <button class="btn btn-secondary" id="btnDelete" title="Delete Selected">
       <span class="tooltip">🗑️ Delete<span class="tooltip-text">Delete selected element(s)</span></span>
    </button>
    <button class="btn btn-secondary" id="btnCopy" title="Copy Selected">
       <span class="tooltip">📄 Copy<span class="tooltip-text">Copy selected element(s)</span></span>
    </button>
    <button class="btn btn-secondary" id="btnPaste" title="Paste">
       <span class="tooltip">📋 Paste<span class="tooltip-text">Paste copied element(s)</span></span>
    </button>
     <button class="btn btn-secondary" id="btnDuplicate" title="Duplicate Selected">
       <span class="tooltip">➕ Duplicate<span class="tooltip-text">Duplicate selected element(s)</span></span>
    </button>
    
    <div class="toolbar-separator"></div>
    
    <button class="btn btn-secondary" id="btnBringForward" title="Bring Forward">
       <span class="tooltip">🔼 Forward<span class="tooltip-text">Bring forward</span></span>
    </button>
    <button class="btn btn-secondary" id="btnSendBackward" title="Send Backward">
       <span class="tooltip">🔽 Backward<span class="tooltip-text">Send backward</span></span>
    </button>
  </div>
  
  <div class="editor-container">
    <div class="slides-panel" id="slides-panel">
      <div class="slides-header">
        <h3>Slides</h3>
        <button id="addSlideButton" class="btn btn-secondary btn-sm" title="Add New Slide">➕</button>
      </div>
      <div id="slides-list">
        <p style="text-align: center; color: #aaa; font-size: 0.9em; padding: 10px;">Loading slides...</p>
      </div>
    </div>
    
    <div class="canvas-panel" id="canvas-panel">
      <div class="canvas-scaler"> 
        <canvas id="editor-canvas">
            Your browser does not support the canvas element.
        </canvas>
      </div>
    </div>
    
    <div class="properties-panel" id="properties-panel">
      <h3>Properties</h3>
      <div id="no-selection-message">
        <p>Select an element on the canvas to edit its properties.</p>
      </div>
      <div id="properties-container" style="display:none;">
        </div>
    </div>
  </div>
  
  <div class="timeline-panel" id="timeline-panel" style="display: none;"> 
    <div class="timeline-controls">
      <button id="playButton" class="btn btn-secondary btn-sm">Play</button>
      <div class="timeline-time" id="current-time">00:00.000</div>
      <div id="timeline-ruler">
        <div id="timeline-playhead"></div>
      </div>
      <div class="timeline-time" id="total-time">00:00.000</div>
    </div>
    <div id="timeline-tracks">
      </div>
  </div>
  
  <div class="dialog hidden" id="addSlideModal">
    <div class="dialog-content">
      <h2>Add New Slide</h2>
      <div class="form-group">
        <label for="slideTitle" class="form-label">Slide Title:</label>
        <input type="text" id="slideTitle" class="form-control" placeholder="Enter slide title">
      </div>
      <div class="form-group">
        <label for="slideBackground" class="form-label">Background Color:</label>
        <input type="color" id="slideBackground" value="#FFFFFF">
      </div>
      <div class="form-group">
        <label for="slideMedia" class="form-label">Background Media:</label>
        <select id="slideMedia" class="form-control">
          <option value="">None</option>
          <option value="image">Image</option>
          <option value="video">YouTube Video</option>
          <option value="audio">Audio</option>
        </select>
      </div>
      <div class="form-group hidden" id="slideMediaUrlGroup">
        <label for="slideMediaUrl" class="form-label">Media URL:</label>
        <input type="text" id="slideMediaUrl" class="form-control" placeholder="Enter YouTube Video URL">
      </div>
      <div class="form-group hidden" id="slideMediaUploadGroup">
        <label for="slideMediaUpload" class="form-label">Upload File:</label>
        <input type="file" id="slideMediaUpload" class="form-control">
        <small id="uploadHelpText" class="form-text text-muted"></small> 
      </div>
       <div id="addSlideStatus" class="status-message"></div> <div class="dialog-actions">
        <button class="btn btn-secondary" id="cancelAddSlideBtn">Cancel</button>
        <button class="btn" id="confirmAddSlideBtn">Add Slide</button>
      </div>
    </div>
  </div>
  
  <div class="dialog hidden" id="addMediaModal">
    <div class="dialog-content">
      <h2>Add Media Element</h2>
      <div class="form-group">
        <label for="mediaType" class="form-label">Media Type:</label>
        <select id="mediaType" class="form-control">
          <option value="youtube">YouTube Video</option>
          <option value="audio">Audio</option>
          </select>
      </div>
       <div class="form-group" id="mediaUrlGroup">
        <label for="mediaUrl" class="form-label">Media URL:</label>
        <input type="text" id="mediaUrl" class="form-control" placeholder="Enter YouTube URL">
      </div>
       <div class="form-group hidden" id="mediaUploadGroup">
        <label for="mediaUpload" class="form-label">Upload Audio File:</label>
        <input type="file" id="mediaUpload" class="form-control" accept="audio/*">
         <small class="form-text text-muted">Upload an audio file (e.g., MP3, WAV).</small>
      </div>
       <div id="addMediaStatus" class="status-message"></div> <div class="dialog-actions">
        <button class="btn btn-secondary" id="cancelAddMediaBtn">Cancel</button>
        <button class="btn" id="confirmAddMediaBtn">Add Media</button>
      </div>
    </div>
  </div>

  <script id="projectData" type="application/json"><?= projectJson ?></script>
  
  <?!= include('UtilsClient'); ?> <?!= include('ConfigClient'); ?> <?!= include('canvas-editor'); ?>
  <?!= include('element-factory'); ?>
  <?!= include('property-panel'); ?>
  
  <!-- Includes -->
  <?!= include('canvas-editor'); ?>
  <?!= include('element-factory'); ?>
  <?!= include('property-panel'); ?>

  <!-- === START UPDATED SCRIPT BLOCK === -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      console.log("EditorView DOMContentLoaded"); // Log entry point

      // --- Data Retrieval and Parsing ---
      const projectDataElement = document.getElementById('projectData');
      if (!projectDataElement) {
          console.error("FATAL: Project data element #projectData not found in the HTML!");
          showAlert("FATAL: Could not find project data container.", "error", "alertContainer", false);
          document.body.innerHTML = `<div style='padding: 20px; color: red;'>Error loading editor: Project data container missing. Please check EditorView.html.</div>`;
          return; // Stop execution
      }

      const projectJson = projectDataElement.dataset.project;
      console.log("Raw project JSON string length:", projectJson ? projectJson.length : 0);
      // Avoid logging potentially huge JSON string fully in production
      if (projectJson) {
        console.log("Raw project JSON sample:", projectJson.substring(0, 200) + "...");
      }


      if (!projectJson) {
           console.error("FATAL: Project JSON data is missing or empty in data-project attribute!");
           showAlert("FATAL: Project JSON data missing.", "error", "alertContainer", false);
           document.body.innerHTML = `<div style='padding: 20px; color: red;'>Error loading editor: Project data attribute missing or empty.</div>`;
           return; // Stop execution
      }

      let projectData;
      try {
          projectData = JSON.parse(projectJson);
          console.log("Parsed project data successfully:", projectData);

          // --- Initialization ---
          // Call initEditor with the PARSED data (assuming initEditor is defined in canvas-editor.js)
          initEditor(projectData);

          // --- Event Listeners (Only set up if initEditor succeeds) ---
          console.log("Setting up event listeners...");

          // Global buttons
          document.getElementById('saveButton').addEventListener('click', saveProject);
          document.getElementById('previewButton').addEventListener('click', previewProject);
          document.getElementById('backToProjectsButton').addEventListener('click', () => {
            window.location.href = window.location.pathname; // Go back to project selector
          });

          // Add slide buttons
          document.getElementById('btnAddSlide').addEventListener('click', showAddSlideModal);
          document.getElementById('addSlideButton').addEventListener('click', showAddSlideModal); // In slides panel
          document.getElementById('cancelAddSlideBtn').addEventListener('click', hideAddSlideModal);
          document.getElementById('confirmAddSlideBtn').addEventListener('click', addNewSlide);

          // Media type change in add slide modal
          document.getElementById('slideMedia').addEventListener('change', function() {
            const mediaType = this.value;
            const urlGroup = document.getElementById('slideMediaUrlGroup');
            const uploadGroup = document.getElementById('slideMediaUploadGroup');
            urlGroup.style.display = (mediaType === 'video') ? 'block' : 'none';
            uploadGroup.style.display = (mediaType === 'image' || mediaType === 'audio') ? 'block' : 'none';
          });

          // Add media modal buttons
          document.getElementById('btnMedia').addEventListener('click', showAddMediaModal);
          document.getElementById('cancelAddMediaBtn').addEventListener('click', hideAddMediaModal);
          document.getElementById('confirmAddMediaBtn').addEventListener('click', addNewMedia);

          // Media type change in add media modal
          document.getElementById('mediaType').addEventListener('change', function() {
            const mediaType = this.value;
            const urlGroup = document.getElementById('mediaUrlGroup');
            const uploadGroup = document.getElementById('mediaUploadGroup');
            urlGroup.style.display = (mediaType === 'youtube') ? 'block' : 'none';
            uploadGroup.style.display = (mediaType === 'audio') ? 'block' : 'none';
          });

          // Shape creation buttons
          document.getElementById('btnRectangle').addEventListener('click', () => createShape('rectangle'));
          document.getElementById('btnCircle').addEventListener('click', () => createShape('circle'));
          document.getElementById('btnText').addEventListener('click', () => createShape('text'));
          document.getElementById('btnHotspot').addEventListener('click', () => createShape('hotspot'));
          document.getElementById('btnArrow').addEventListener('click', () => createShape('arrow'));

          // Editing operations buttons
          document.getElementById('btnDelete').addEventListener('click', deleteSelectedObjects);
          document.getElementById('btnCopy').addEventListener('click', copySelectedObjects);
          document.getElementById('btnPaste').addEventListener('click', pasteObjects);
          document.getElementById('btnBringForward').addEventListener('click', bringForward);
          document.getElementById('btnSendBackward').addEventListener('click', sendBackward);

          // Upload image button
          document.getElementById('btnUploadImage').addEventListener('click', uploadImage);

          console.log("Event listeners set up.");

      } catch (e) {
          console.error("FATAL: Failed to parse project JSON:", e);
          console.error("JSON string that failed:", projectJson); // Log the problematic string
          showAlert(`FATAL: Could not parse project data. Error: ${e.message}. Check console for details.`, "error", "alertContainer", false); // Make error visible
          document.body.innerHTML = `<div style='padding: 20px; color: red;'>Error loading editor data. Invalid format. Check console.</div>`; // Overwrite body on critical error
          // Stop further execution in this block
          return;
      }
    }); // End DOMContentLoaded

    // --- Function Definitions ---
    // (These functions are called by the event listeners above. They might be defined
    // here, or in the included files like canvas-editor.js. Keeping them here for
    // reference based on the previous example, but ideally they live in included files.)

    // Functions for modals
    function showAddSlideModal() {
      // Ensure editorState is initialized before accessing project
      if (!window.editorState || !editorState.project || !editorState.project.slides) {
          console.error("Cannot show add slide modal: editor state not ready.");
          showAlert("Editor not fully loaded, please wait.", "warning");
          return;
      }
      document.getElementById('addSlideModal').classList.remove('hidden');
      document.getElementById('slideTitle').value = 'Slide ' + (editorState.project.slides.length + 1);
      document.getElementById('slideBackground').value = '#FFFFFF';
      document.getElementById('slideMedia').value = '';
      document.getElementById('slideMediaUrl').value = '';
      document.getElementById('slideMediaUpload').value = ''; // Clear file input
      document.getElementById('slideMediaUrlGroup').style.display = 'none';
      document.getElementById('slideMediaUploadGroup').style.display = 'none';
    }

    function hideAddSlideModal() {
      document.getElementById('addSlideModal').classList.add('hidden');
    }

    function showAddMediaModal() {
      document.getElementById('addMediaModal').classList.remove('hidden');
      document.getElementById('mediaType').value = 'youtube';
      document.getElementById('mediaUrl').value = '';
      document.getElementById('mediaUpload').value = ''; // Clear file input
      document.getElementById('mediaUrlGroup').style.display = 'block';
      document.getElementById('mediaUploadGroup').style.display = 'none';
    }

    function hideAddMediaModal() {
      document.getElementById('addMediaModal').classList.add('hidden');
    }

    // Save project function
    async function saveProject() {
      // Assuming serializeProject() is defined in canvas-editor.js and returns the current project state
      if (typeof serializeProject !== 'function') {
           console.error("saveProject error: serializeProject function not found.");
           showAlert("Error: Cannot serialize project state.", "error");
           return;
      }
      const projectToSave = serializeProject();
      if (!projectToSave || !projectToSave.projectId) {
          console.error("saveProject error: Invalid project data from serializeProject.");
          showAlert("Error: Invalid project data.", "error");
          return;
      }


      showAlert('Saving project...', 'info');

      // Define the updates to send - be specific!
      const updatesToSend = {
          slides: projectToSave.slides,
          elements: projectToSave.elements
          // Add other fields ONLY if they are meant to be updated from the editor
          // title: projectToSave.title, // Example if title is editable
      };

      try {
          // Use the global 'api' instance from Common.html
          const result = await api.updateProject(projectToSave.projectId, updatesToSend);
          console.log("Save successful:", result); // ApiClient already handles the {success, data} structure
          showAlert('Project saved successfully!', 'success');
      } catch (error) {
          console.error("Save project error:", error);
          showAlert('Error saving project: ' + error.message, 'error');
      }
    }

    // Preview project function
    function previewProject() {
       if (!window.editorState || !editorState.project || !editorState.project.projectId) {
           console.error("Cannot preview: editor state not ready.");
           showAlert("Editor not fully loaded, cannot preview.", "warning");
           return;
       }
      const url = window.location.pathname + '?project=' + editorState.project.projectId;
      window.open(url, '_blank');
    }

    // Add new slide function
    async function addNewSlide() {
       if (!window.editorState || !editorState.project || !editorState.project.projectId) {
           console.error("Cannot add slide: editor state not ready.");
           showAlert("Editor not fully loaded, cannot add slide.", "warning");
           return;
       }
      const title = document.getElementById('slideTitle').value;
      const backgroundColor = document.getElementById('slideBackground').value;
      const mediaTypeSelect = document.getElementById('slideMedia');
      const mediaType = mediaTypeSelect.value;
      const mediaUrl = document.getElementById('slideMediaUrl').value;
      const mediaFileInput = document.getElementById('slideMediaUpload');
      const mediaFile = mediaFileInput.files[0];

      const fileTypeMap = {
          'image': 'Image',
          'video': 'YouTube Video',
          'audio': 'Audio',
          '': ''
      };

      const slideData = {
        title: title || 'Untitled Slide',
        backgroundColor: backgroundColor,
        fileType: fileTypeMap[mediaType],
        showControls: true, // Default? Or make it an option?
        fileUrl: '' // Initialize
      };

      try {
          if (mediaType === 'video' && mediaUrl) {
              slideData.fileUrl = mediaUrl;
              const response = await api.addSlide(editorState.project.projectId, slideData);
              console.log("Slide added via API (Video URL):", response);
              // Update local state immediately for responsiveness
              if (response && response.slide) { // Check API response structure
                  editorState.project.slides.push(response.slide);
                  if (typeof loadSlides === 'function') loadSlides(); // Reload slides panel if function exists
                  if (typeof loadSlide === 'function') loadSlide(response.slide.slideId); // Load the new slide if function exists
              }
              hideAddSlideModal();
              showAlert('Slide added successfully!', 'success');

          } else if ((mediaType === 'image' || mediaType === 'audio') && mediaFile) {
              showAlert('Uploading media file...', 'info');
              const uploadResult = await uploadMediaFile(mediaFile, mediaType); // Assumes this returns { success: bool, file: { downloadUrl: string } }
              slideData.fileUrl = uploadResult.file.downloadUrl; // Use URL from upload
              const response = await api.addSlide(editorState.project.projectId, slideData);
              console.log("Slide added via API (File Upload):", response);
              if (response && response.slide) {
                   editorState.project.slides.push(response.slide);
                   if (typeof loadSlides === 'function') loadSlides();
                   if (typeof loadSlide === 'function') loadSlide(response.slide.slideId);
              }
              hideAddSlideModal();
              showAlert('Media uploaded and slide added!', 'success');

          } else { // No media
              const response = await api.addSlide(editorState.project.projectId, slideData);
              console.log("Slide added via API (No Media):", response);
               if (response && response.slide) {
                   editorState.project.slides.push(response.slide);
                   if (typeof loadSlides === 'function') loadSlides();
                   if (typeof loadSlide === 'function') loadSlide(response.slide.slideId);
               }
              hideAddSlideModal();
              showAlert('Slide added successfully!', 'success');
          }
      } catch (error) {
          console.error("Error adding slide:", error);
          showAlert(`Error adding slide: ${error.message}`, 'error');
      } finally {
           mediaFileInput.value = ''; // Clear file input regardless of success/failure
      }
    }

    // Add media element function
    async function addNewMedia() {
      // This function likely needs to interact heavily with canvas-editor.js
      // to actually *add* the element to the canvas after processing/uploading.
       if (!window.editorState || !editorState.project || !editorState.currentSlide) {
           console.error("Cannot add media element: editor state not ready.");
           showAlert("Editor not fully loaded or no slide selected.", "warning");
           return;
       }
      const mediaType = document.getElementById('mediaType').value;
      const mediaUrl = document.getElementById('mediaUrl').value;
      const mediaFileInput = document.getElementById('mediaUpload');
      const mediaFile = mediaFileInput.files[0];

      showAlert('Processing media...', 'info');

      try {
          if (mediaType === 'youtube' && mediaUrl) {
              // Usually, YouTube videos are background/slide level, not elements.
              // If it's meant to be an element, you need a canvas-editor function.
              console.warn("Adding YouTube as element not standard. Check requirements.");
              showAlert("Adding YouTube as element not implemented.", "warning");
              // Example: if (typeof addYouTubeElement === 'function') addYouTubeElement(mediaUrl);
              hideAddMediaModal();

          } else if (mediaType === 'audio' && mediaFile) {
              const uploadResult = await uploadMediaFile(mediaFile, 'audio');
              showAlert('Audio uploaded. Adding element...', 'info');
              // Now, add the audio element to the canvas/project data
              // This likely requires calling a function in canvas-editor.js
              // Example: if (typeof addAudioElement === 'function') addAudioElement(uploadResult.file.downloadUrl);
              console.warn("Adding Audio element to canvas not implemented.");
              showAlert("Audio uploaded, element addition pending.", "warning");
              hideAddMediaModal();

          } else {
               showAlert("Invalid media selection.", "warning");
          }
      } catch (error) {
          console.error("Error adding media:", error);
          showAlert(`Error adding media: ${error.message}`, 'error');
      } finally {
          mediaFileInput.value = ''; // Clear file input
      }
    }

    // Upload media file function (placeholder - REQUIRES SERVER IMPLEMENTATION)
    function uploadMediaFile(file, type) {
        // This needs to call google.script.run to a server-side function
        // that uses FileUploader.js to handle the upload.
        return new Promise((resolve, reject) => {
             console.warn("uploadMediaFile called - requires server implementation.");
             showAlert('File upload functionality requires server-side setup.', 'warning');

             // --- Example using FileReader (client-side part) ---
             const reader = new FileReader();
             reader.onload = (e) => {
                 const fileData = e.target.result.split(','); // Get base64 part
                 const fileInfo = {
                     fileName: file.name,
                     mimeType: file.type,
                     data: fileData[1] // Base64 string
                 };
                 console.log(`Read file ${file.name}, size ${file.size}, type ${file.type}. Calling server...`);

                 // *** Replace with your actual server-side upload function ***
                 google.script.run
                     .withSuccessHandler(response => {
                         console.log("Server upload response:", response);
                         if (response && response.success && response.file) {
                             resolve(response); // Should contain { success: true, file: { downloadUrl: ... } }
                         } else {
                              reject(new Error(response.message || 'Server upload failed.'));
                         }
                     })
                     .withFailureHandler(error => {
                          console.error("Server upload error:", error);
                          reject(error);
                     })
                     .uploadFileToServer(fileInfo, editorState.project.projectId, type); // <<< Example server function name

             };
             reader.onerror = (e) => {
                 console.error("FileReader error:", e);
                 reject(new Error("Failed to read file locally."));
             };
             reader.readAsDataURL(file); // Read file as Base64
        });
    }

    // Upload image function (Trigger for file input)
    function uploadImage() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';

      input.onchange = async function(event) { // Make async
        const file = event.target.files[0];
        if (file) {
           showAlert('Uploading image...', 'info');
           try {
               const uploadResult = await uploadMediaFile(file, 'image');
               showAlert('Image uploaded. Adding to canvas...', 'info');
                // Assumes addImageElement exists in canvas-editor.js and handles adding
                // the element to both the canvas and the project data structure
                if (typeof addImageElement === 'function') {
                    addImageElement(uploadResult.file.downloadUrl); // Pass URL to the function
                    showAlert('Image added successfully!', 'success');
                } else {
                    console.error("addImageElement function not found in canvas-editor.js");
                    showAlert('Image uploaded, but failed to add to canvas.', 'warning');
                }
           } catch (error) {
               console.error("Image upload/add error:", error);
               showAlert('Error uploading/adding image: ' + error.message, 'error');
           } finally {
               input.value = ''; // Clear file input
           }
        }
      };
      input.click();
    }

    // --- Placeholders for functions assumed to be in included files ---
    // These need to be defined in canvas-editor.js or element-factory.js etc.
    function initEditor(projectData) { console.warn("initEditor placeholder called"); }
    function serializeProject() { console.warn("serializeProject placeholder called"); return editorState.project; }
    function createShape(type) { console.warn("createShape placeholder called", type); }
    function deleteSelectedObjects() { console.warn("deleteSelectedObjects placeholder called"); }
    function copySelectedObjects() { console.warn("copySelectedObjects placeholder called"); }
    function pasteObjects() { console.warn("pasteObjects placeholder called"); }
    function bringForward() { console.warn("bringForward placeholder called"); }
    function sendBackward() { console.warn("sendBackward placeholder called"); }
    function addImageElement(url) { console.warn("addImageElement placeholder called", url); }
    // Add placeholders for any other functions called by buttons/listeners if not defined here

  </script>
  <!-- === END UPDATED SCRIPT BLOCK === -->

</body>
</html>